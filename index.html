<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Redes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS DO SISTEMA PRINCIPAL */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --light: #ecf0f1;
            --dark: #34495e;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #1abc9c;
            --bg-color: #f5f7fa;
            --text-color: #333;
            --card-bg: white;
            --border-color: #ddd;
            --header-bg: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: var(--header-bg);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
            align-items: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        nav a:hover, nav a.active {
            background-color: rgba(255,255,255,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .logout-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }

        main {
            padding: 2rem 0;
            min-height: calc(100vh - 140px);
        }

        .page-title {
            margin-bottom: 1.5rem;
            color: var(--dark);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-warning {
            background-color: var(--warning);
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-info {
            background-color: var(--info);
        }

        .btn-info:hover {
            background-color: #16a085;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .hidden {
            display: none !important;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: var(--light);
        }

        .login-form {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-form h2 {
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--primary);
        }

        .alert {
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 4px;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .role-admin { background-color: #e74c3c; color: white; }
        .role-supervisao { background-color: #e67e22; color: white; }
        .role-analistas { background-color: #f39c12; color: white; }
        .role-tecnico { background-color: #3498db; color: white; }
        .role-projetos { background-color: #9b59b6; color: white; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            text-align: center;
        }

        .stat-card h3 {
            margin-bottom: 0.5rem;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary);
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-type {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .log-info { background-color: #d4edda; color: #155724; }
        .log-warning { background-color: #fff3cd; color: #856404; }
        .log-error { background-color: #f8d7da; color: #721c24; }
        .log-security { background-color: #cce7ff; color: #004085; }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .table-container {
            overflow-x: auto;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* CSS ESPEC√çFICO DO SISTEMA DE COORDENADAS */
        .abas-navegacao {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1.5rem;
        }

        .aba {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .aba.active {
            border-bottom-color: var(--secondary);
            color: var(--secondary);
            font-weight: bold;
        }

        .aba:hover {
            background-color: #f8f9fa;
        }

        .conteudo-aba {
            display: none;
        }

        .conteudo-aba.active {
            display: block;
        }

        .checkbox-column {
            width: 40px;
            text-align: center;
        }

        .destaque-pesquisa {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
            font-weight: bold;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
            gap: 5px;
        }

        .pagination button {
            padding: 0.5rem 0.75rem;
        }

        .pagination button.active {
            background-color: var(--primary);
        }

        .pagination-info {
            text-align: center;
            margin-top: 1rem;
            color: #6c757d;
            font-size: 0.875rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 1rem;
        }

        .info-pesquisa {
            background-color: #e8f4fd;
            border-left: 4px solid #3498db;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .stats-info {
            background-color: #e8f4fd;
            border-left: 4px solid var(--secondary);
            padding: 0.75rem;
            margin-top: 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .search-input-container {
            flex: 2;
            position: relative;
            min-width: 300px;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .search-input-coordenadas {
            padding-left: 35px;
            width: 100%;
        }

        .categoria-select {
            min-width: 220px;
            flex: 1;
        }

        .btn-limpar {
            min-width: 100px;
            flex-shrink: 0;
        }

        .copy-button-container {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
            gap: 10px;
        }

        .option-with-count {
            display: flex;
            justify-content: space-between;
        }

        .option-count {
            font-size: 0.8rem;
            color: #6c757d;
            margin-left: 10px;
        }

        /* Toast para notifica√ß√µes */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.error {
            background-color: var(--danger);
        }

        /* CSS ESPEC√çFICO DO SISTEMA DE MATERIAIS */
        .tabs-materiais {
            display: flex;
            margin: 20px 0;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        
        .tab-materiais {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab-materiais.active {
            border-bottom: 3px solid var(--secondary);
            color: var(--secondary);
            font-weight: bold;
        }
        
        .tab-content-materiais {
            display: none;
        }
        
        .tab-content-materiais.active {
            display: block;
        }
        
        .search-container-materiais {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .search-bar-materiais {
            display: flex;
            margin-bottom: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .search-input-container-materiais {
            position: relative;
            flex: 1;
            min-width: 200px;
        }
        
        .search-input-container-materiais input {
            width: 100%;
            padding: 10px 40px 10px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .clear-search-materiais {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 5px;
            display: none;
        }
        
        .clear-search-materiais:hover {
            color: var(--danger);
        }
        
        .search-bar-materiais select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            flex: 1;
            min-width: 200px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .btn-materiais {
            padding: 8px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            height: 36px;
            white-space: nowrap;
        }
        
        .btn-edit-materiais {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-edit-materiais:hover {
            background-color: #e67e22;
        }
        
        .btn-delete-materiais {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-delete-materiais:hover {
            background-color: #c0392b;
        }

        .btn-save-materiais {
            background-color: var(--success);
            color: white;
        }
        
        .btn-save-materiais:hover {
            background-color: #27ae60;
        }
        
        .form-container-materiais {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        
        .form-group-materiais {
            margin-bottom: 15px;
        }
        
        .form-group-materiais label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group-materiais input, .form-group-materiais select, .form-group-materiais textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .form-group-materiais textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row-materiais {
            display: flex;
            gap: 15px;
        }
        
        .form-row-materiais .form-group-materiais {
            flex: 1;
        }
        
        .form-actions-materiais {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-primary-materiais {
            background-color: var(--secondary);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary-materiais:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary-materiais {
            background-color: #95a5a6;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .btn-secondary-materiais:hover {
            background-color: #7f8c8d;
        }
        
        .no-results-materiais {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .form-title-materiais {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-options-materiais {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .export-btn-materiais {
            background-color: var(--info);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .export-btn-materiais:hover {
            background-color: #16a085;
        }
        
        .validation-error-materiais {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
        
        .input-error-materiais {
            border-color: var(--danger) !important;
        }

        .status-message-materiais {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }

        .status-success-materiais {
            background-color: var(--success);
            color: white;
        }

        .status-error-materiais {
            background-color: var(--danger);
            color: white;
        }

        .status-warning-materiais {
            background-color: var(--warning);
            color: white;
        }

        .status-info-materiais {
            background-color: var(--info);
            color: white;
        }

        .categoria-actions-materiais {
            display: flex;
            gap: 5px;
        }

        /* NOVOS ESTILOS PARA SISTEMA DE CAIXAS CORRIGIDO */
        .caixa-item {
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            background-color: #f8f9fa;
        }

        .caixa-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .caixa-nome {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .caixa-details {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .caixa-checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.25rem;
        }

        .caixa-checkbox {
            margin: 0;
            width: auto;
        }

        .caixa-selecionada {
            background-color: #e3f2fd !important;
            border-left: 4px solid #3498db;
        }

        .utilizar-caixas-container {
            margin-bottom: 1rem;
            text-align: right;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .caixa-nome-container {
            display: flex;
            align-items: center;
        }

        .caixa-item-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .caixa-info {
            flex: 1;
        }

        .caixa-details-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.25rem 0.5rem;
            align-items: center;
        }

        .caixa-details-grid .caixa-checkbox-container {
            grid-column: 1;
            grid-row: 1;
        }

        .caixa-details-grid .cadastro-info {
            grid-column: 2;
            grid-row: 1;
        }

        .caixa-details-grid .data-info {
            grid-column: 2;
            grid-row: 2;
        }

        .caixa-details strong {
            display: inline;
            font-weight: 600;
        }

        .caixa-actions {
            display: flex;
            gap: 5px;
            margin-top: 0.5rem;
        }

        /* NOVOS ESTILOS PARA SISTEMA DE MATERIAIS COMPLETO */
        .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .selection-info {
            font-size: 14px;
            color: var(--text-color);
        }

        .copy-btn {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .copy-btn:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .copy-btn:hover:not(:disabled) {
            background-color: #2d9e64;
        }

        .select-all {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .select-all input {
            cursor: pointer;
        }

        .solicitacao-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .solicitacao-itens {
            flex: 2;
        }

        .solicitacao-form {
            flex: 1;
        }

        .email-preview {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .email-preview h4 {
            margin-bottom: 10px;
            color: var(--secondary);
        }

        .email-preview-content {
            white-space: pre-wrap;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
        }

        .btn-outlook {
            background-color: #0072C6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            margin-top: 15px;
            width: 100%;
            justify-content: center;
        }

        .btn-outlook:hover {
            background-color: #005a9e;
        }

        .btn-outlook:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .quantidade-input {
            width: 80px;
            padding: 6px 8px;
            border: 1.5px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
            text-align: center;
        }

        .quantidade-input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.1);
        }

        .quantidade-input.invalid {
            border-color: var(--danger);
        }

        .categoria-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .categoria-item:last-child {
            border-bottom: none;
        }

        .categoria-actions {
            display: flex;
            gap: 5px;
        }

        .tooltip {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--success);
            color: white;
            padding: 10px 12px;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            font-size: 12px;
            font-weight: 500;
        }

        /* MODAIS - Estilos corrigidos para ficarem apenas na aba de caixas */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 10px;
            }

            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .search-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input-container,
            .categoria-select,
            .btn-limpar {
                width: 100%;
                min-width: auto;
            }

            .search-bar-materiais {
                flex-direction: column;
            }
            
            .form-row-materiais {
                flex-direction: column;
            }
            
            table {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            .actions {
                flex-direction: column;
            }

            .categoria-actions-materiais {
                flex-direction: column;
            }

            .utilizar-caixas-container {
                flex-direction: column;
            }
            
            .caixa-item-content {
                flex-direction: column;
            }
            
            .caixa-actions {
                margin-top: 1rem;
                width: 100%;
                justify-content: flex-end;
            }

            .selection-controls {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .solicitacao-container {
                flex-direction: column;
            }

            .categoria-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .categoria-actions {
                width: 100%;
                justify-content: flex-end;
                flex-direction: row !important;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- P√°gina de Login -->
    <div id="login-page" class="login-container">
        <div class="login-form">
            <h2>üåê Gest√£o de Redes</h2>
            <div id="login-alert" class="alert alert-danger hidden"></div>
            <div id="setup-status" class="alert alert-info hidden"></div>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required value="admin@sistema.com">
                </div>
                <div class="form-group">
                    <label for="login-password">Senha</label>
                    <input type="password" id="login-password" required value="Kowa2013">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn-primary" style="width: 100%;" id="login-button">Entrar</button>
                </div>
                <div style="text-align: center; margin-top: 1rem; color: #666; font-size: 0.9rem;">
                    <strong>Credenciais padr√£o pr√©-preenchidas</strong>
                </div>
            </form>
        </div>
    </div>

    <!-- Sistema Principal (inicialmente oculto) -->
    <div id="main-system" class="hidden">
        <header>
            <div class="container header-content">
                <div class="logo">
                    <span>üåê</span>
                    <h1>Gest√£o de Redes</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" id="nav-dashboard" class="nav-link active">Dashboard</a></li>
                        <li><a href="#" id="nav-usuarios" class="nav-link">Usu√°rios</a></li>
                        <li><a href="#" id="nav-coordenadas" class="nav-link">Coordenadas</a></li>
                        <li><a href="#" id="nav-materiais" class="nav-link">Materiais</a></li>
                    </ul>
                </nav>
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <span id="user-name">Administrador</span>
                    <span class="role-badge" id="user-role">Administrador</span>
                    <button class="logout-btn" id="logout-btn">Sair</button>
                </div>
            </div>
        </header>

        <main class="container">
            <!-- P√°gina Dashboard -->
            <section id="page-dashboard" class="page-content active">
                <h2 class="page-title"><span>üìä</span>Dashboard</h2>
                
                <div class="card">
                    <h3 id="welcome-message">Bem-vindo!</h3>
                    <p>Seu n√≠vel de acesso: <span id="user-role-badge" class="role-badge role-admin">Administrador</span></p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total de Usu√°rios</h3>
                            <div class="stat-number" id="total-usuarios">1</div>
                        </div>
                        <div class="stat-card">
                            <h3>Coordenadas</h3>
                            <div class="stat-number" id="total-coordenadas">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Materiais</h3>
                            <div class="stat-number" id="total-materiais">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Status do Sistema</h3>
                            <div class="stat-number">‚úÖ</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Funcionalidades do Sistema</h3>
                    <div style="padding: 1rem;">
                        <p>‚úÖ <strong>Sistema carregado com sucesso!</strong></p>
                        <p>üéØ <strong>Funcionalidades dispon√≠veis:</strong></p>
                        <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                            <li><strong>Usu√°rios:</strong> Gerenciamento completo de usu√°rios e hierarquias</li>
                            <li><strong>Coordenadas:</strong> Sistema de geolocaliza√ß√£o e mapeamento</li>
                            <li><strong>Materiais:</strong> Controle de invent√°rio e estoque</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3>Atividades Recentes</h3>
                    <div style="padding: 1rem;" id="atividades-recentes">
                        <div class="log-entry">
                            <div>
                                <strong>Login realizado com sucesso</strong>
                                <div style="font-size: 0.875rem; color: #666; margin-top: 5px;">
                                    <span id="login-user">Usu√°rio</span> | <span id="login-time"></span>
                                </div>
                            </div>
                            <span class="log-type log-info">INFO</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- P√°gina Usu√°rios -->
            <section id="page-usuarios" class="page-content">
                <h2 class="page-title"><span>üë•</span>Gerenciar Usu√°rios</h2>
                
                <div class="card">
                    <div class="search-bar">
                        <input type="text" id="search-usuarios" placeholder="Buscar usu√°rios..." class="search-input">
                        <button id="btn-novo-usuario" class="btn-success">+ Novo Usu√°rio</button>
                    </div>

                    <div class="table-container">
                        <table id="tabela-usuarios">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Hierarquia</th>
                                    <th>Status</th>
                                    <th>Data Cadastro</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-usuarios">
                                <!-- Dados carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- P√°gina Coordenadas - SISTEMA CORRIGIDO -->
            <section id="page-coordenadas" class="page-content">
                <h2 class="page-title">
                    <span>üìç</span>
                    Gerenciar Coordenadas
                </h2>
                
                <!-- Abas de navega√ß√£o -->
                <div class="abas-navegacao">
                    <div class="aba active" id="aba-consulta">Consulta de Coordenadas</div>
                    <div class="aba" id="aba-caixas">Caixas Dispon√≠veis</div>
                </div>

                <!-- Conte√∫do da aba Consulta -->
                <div id="conteudo-consulta" class="conteudo-aba active">
                    <div class="card">
                        <div id="info-pesquisa" class="info-pesquisa hidden">
                            <!-- Informa√ß√µes sobre a pesquisa ser√£o inseridas aqui -->
                        </div>
                        
                        <div class="search-bar">
                            <div class="search-input-container">
                                <span class="search-icon">üîç</span>
                                <input type="text" id="search-input" class="search-input-coordenadas" placeholder="Digite para pesquisar por nome, localiza√ß√£o ou tipo (separado por ; sem espa√ßos)">
                            </div>
                            <select id="tipo-local-select" class="categoria-select">
                                <option value="">Todos os Tipos de Local</option>
                                <!-- Tipos de local ser√£o carregados dinamicamente -->
                            </select>
                            <button id="btn-limpar-pesquisa" class="btn-danger btn-limpar">Limpar</button>
                        </div>
                        
                        <!-- Bot√£o de c√≥pia e exclus√£o -->
                        <div class="copy-button-container">
                            <button id="btn-copiar" class="btn-success">Copiar</button>
                            <button id="btn-excluir-coordenadas" class="btn-danger hidden">Excluir Selecionadas</button>
                        </div>
                        
                        <div class="table-container">
                            <div id="loading-coordenadas" class="loading hidden">
                                <div class="loading-spinner"></div>
                                <p>Carregando coordenadas...</p>
                            </div>
                            <table id="tabela-coordenadas">
                                <thead>
                                    <tr>
                                        <th class="checkbox-column">Selecionar</th>
                                        <th>Nome</th>
                                        <th>Tipo de Local</th>
                                        <th>Latitude (Y)</th>
                                        <th>Longitude (X)</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-corpo">
                                    <!-- Linhas de coordenadas ser√£o inseridas aqui -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="empty-state" class="empty-state hidden">
                            <div class="empty-state-icon">üó∫Ô∏è</div>
                            <p>Nenhuma coordenada encontrada.</p>
                        </div>

                        <!-- Controles de pagina√ß√£o -->
                        <div id="pagination-controls" class="pagination hidden">
                            <!-- Bot√µes de pagina√ß√£o ser√£o inseridas aqui -->
                        </div>
                        
                        <div id="pagination-info" class="pagination-info hidden">
                            <!-- Informa√ß√µes da pagina√ß√£o ser√£o inseridas aqui -->
                        </div>

                        <!-- Estat√≠sticas de carregamento -->
                        <div id="stats-info" class="stats-info hidden">
                            <strong>üìä Estat√≠sticas de Carregamento:</strong> 
                            <span id="stats-text">Carregando estat√≠sticas...</span>
                        </div>
                    </div>
                </div>

                <!-- Conte√∫do da aba Caixas - SISTEMA CORRIGIDO -->
                <div id="conteudo-caixas" class="conteudo-aba">
                    <!-- MODAIS PARA CAIXAS (APENAS AQUI) -->
                    <!-- Modal para retornar caixa -->
                    <div id="modal-retornar-caixa" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Retornar Caixa para Dispon√≠vel</h3>
                                <button class="close-modal">&times;</button>
                            </div>
                            <form id="form-retornar-caixa">
                                <input type="hidden" id="caixa-id-retornar" name="caixa-id">
                                
                                <div class="form-group">
                                    <p>Tem certeza que deseja retornar esta caixa para a lista de dispon√≠veis?</p>
                                    <p><strong>Caixa:</strong> <span id="caixa-nome-retornar"></span></p>
                                </div>
                                
                                <div class="modal-footer">
                                    <button type="button" class="btn-danger" id="btn-cancelar-retorno">Cancelar</button>
                                    <button type="submit" class="btn-success">Confirmar Retorno</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Modal para mover caixa para coordenadas -->
                    <div id="modal-mover-coordenadas" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Mover Caixa para Caixas Ativas</h3>
                                <button class="close-modal">&times;</button>
                            </div>
                            <form id="form-mover-coordenadas">
                                <input type="hidden" id="caixa-id-mover" name="caixa-id">
                                
                                <div class="form-group">
                                    <p>Informe as coordenadas para mover a caixa:</p>
                                    <p><strong>Caixa:</strong> <span id="caixa-nome-mover"></span></p>
                                </div>
                                
                                <div class="form-group">
                                    <label for="latitude-mover">Latitude (Y)</label>
                                    <input type="text" id="latitude-mover" name="latitude-mover" required placeholder="Ex: -23.5505">
                                </div>
                                
                                <div class="form-group">
                                    <label for="longitude-mover">Longitude (X)</label>
                                    <input type="text" id="longitude-mover" name="longitude-mover" required placeholder="Ex: -46.6333">
                                </div>
                                
                                <div class="modal-footer">
                                    <button type="button" class="btn-danger" id="btn-cancelar-mover">Cancelar</button>
                                    <button type="submit" class="btn-success">Confirmar Movimento</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Modal para utilizar caixas selecionadas -->
                    <div id="modal-utilizar-caixas" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Utilizar Caixa(s) Selecionada(s)</h3>
                                <button class="close-modal">&times;</button>
                            </div>
                            <form id="form-utilizar-caixas">
                                <div class="form-group">
                                    <p>Informe os dados para utilizar a(s) caixa(s) selecionada(s):</p>
                                    <p><strong>Caixas selecionadas:</strong> <span id="caixas-selecionadas-nomes"></span></p>
                                </div>
                                
                                <div class="form-group">
                                    <label for="usuario-utilizacao">Usu√°rio que est√° utilizando</label>
                                    <input type="text" id="usuario-utilizacao" name="usuario-utilizacao" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="evento-utilizacao">Evento</label>
                                    <input type="text" id="evento-utilizacao" name="evento-utilizacao" required>
                                </div>
                                
                                <div class="modal-footer">
                                    <button type="button" class="btn-danger" id="btn-cancelar-utilizacao">Cancelar</button>
                                    <button type="submit" class="btn-success">Confirmar Utiliza√ß√£o</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Modal para editar caixas selecionadas -->
                    <div id="modal-editar-caixas" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Editar Caixa(s) Selecionada(s)</h3>
                                <button class="close-modal">&times;</button>
                            </div>
                            <form id="form-editar-caixas">
                                <div class="form-group">
                                    <p>Editar informa√ß√µes da(s) caixa(s) selecionada(s):</p>
                                    <p><strong>Caixas selecionadas:</strong> <span id="caixas-selecionadas-nomes-editar"></span></p>
                                </div>
                                
                                <div class="form-group">
                                    <label for="novo-nome-caixa">Novo Nome (deixe vazio para manter o atual)</label>
                                    <input type="text" id="novo-nome-caixa" name="novo-nome-caixa" placeholder="Novo nome para as caixas">
                                </div>
                                
                                <div class="form-group">
                                    <label for="novo-usuario-caixa">Novo Usu√°rio (deixe vazio para manter o atual)</label>
                                    <input type="text" id="novo-usuario-caixa" name="novo-usuario-caixa" placeholder="Novo usu√°rio para as caixas">
                                </div>
                                
                                <div class="modal-footer">
                                    <button type="button" class="btn-danger" id="btn-cancelar-editar">Cancelar</button>
                                    <button type="submit" class="btn-success">Confirmar Edi√ß√£o</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Modal para confirmar exclus√£o -->
                    <div id="modal-confirmar-exclusao" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Confirmar Exclus√£o</h3>
                                <button class="close-modal">&times;</button>
                            </div>
                            <form id="form-confirmar-exclusao">
                                <div class="form-group">
                                    <p>Tem certeza que deseja excluir os itens selecionados?</p>
                                    <p><strong>Itens selecionados:</strong> <span id="itens-selecionados-exclusao"></span></p>
                                    <p class="categoria-info">Esta a√ß√£o n√£o pode ser desfeita.</p>
                                </div>
                                
                                <div class="modal-footer">
                                    <button type="button" class="btn-warning" id="btn-cancelar-exclusao">Cancelar</button>
                                    <button type="submit" class="btn-danger">Confirmar Exclus√£o</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- CONTE√öDO DA ABA CAIXAS -->
                    <div class="card">
                        <h3>Caixas Dispon√≠veis</h3>
                        
                        <!-- Container para os bot√µes de a√ß√£o (aparece apenas quando h√° sele√ß√µes) -->
                        <div id="utilizar-caixas-container" class="utilizar-caixas-container hidden">
                            <button id="btn-utilizar-caixas" class="btn-success">Utilizar Caixa(s)</button>
                            <button id="btn-editar-caixas" class="btn-warning">Editar Selecionadas</button>
                            <button id="btn-excluir-caixas" class="btn-danger">Excluir Selecionadas</button>
                        </div>
                        
                        <div id="loading-caixas-disponiveis" class="loading hidden">
                            <div class="loading-spinner"></div>
                            <p>Carregando caixas dispon√≠veis...</p>
                        </div>
                        <div id="lista-caixas-disponiveis">
                            <!-- Lista de caixas dispon√≠veis ser√° inserida aqui -->
                        </div>
                        
                        <div id="empty-state-caixas" class="empty-state hidden">
                            <div class="empty-state-icon">üì¶</div>
                            <p>Nenhuma caixa dispon√≠vel encontrada.</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Caixas Reservadas</h3>
                        <div id="loading-caixas-utilizadas" class="loading hidden">
                            <div class="loading-spinner"></div>
                            <p>Carregando caixas reservadas...</p>
                        </div>
                        <div id="lista-caixas-utilizadas">
                            <!-- Lista de caixas reservadas ser√° inserida aqui -->
                        </div>
                        
                        <div id="empty-state-caixas-utilizadas" class="empty-state hidden">
                            <div class="empty-state-icon">üì¶</div>
                            <p>Nenhuma caixa reservada encontrada.</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Cadastrar Nova(s) Caixa(s)</h3>
                        <div class="categoria-info">
                            <strong>Nota:</strong> Todas as caixas ser√£o automaticamente categorizadas como "Caixa CE"
                        </div>
                        <form id="form-caixas">
                            <div class="form-group">
                                <label for="caixas-texto">Nomes das Caixas (separados por ;)</label>
                                <textarea id="caixas-texto" name="caixas-texto" rows="4" placeholder="Ex: CAIXA A; CAIXA B; CAIXA C"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="usuario-cadastro">Usu√°rio que est√° cadastrando</label>
                                <input type="text" id="usuario-cadastro" name="usuario-cadastro" required>
                            </div>
                            
                            <div class="form-group">
                                <button type="submit" id="btn-cadastrar-caixas" class="btn-success">Cadastrar Caixas</button>
                                <button type="button" id="btn-limpar-caixas" class="btn-danger">Limpar Formul√°rio</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- P√°gina Materiais - SISTEMA COMPLETO -->
            <section id="page-materiais" class="page-content">
                <h2 class="page-title"><span>üì¶</span>Gerenciar Materiais</h2>
                
                <div id="statusMessageMateriais"></div>
                
                <div class="tabs-materiais">
                    <div class="tab-materiais active" data-tab="consultar-materiais"><i class="fas fa-search"></i> Consultar Materiais</div>
                    <div class="tab-materiais" data-tab="cadastrar-materiais"><i class="fas fa-plus-circle"></i> Cadastrar Material</div>
                    <div class="tab-materiais" data-tab="categorias-materiais"><i class="fas fa-tags"></i> Gerenciar Categorias</div>
                    <div class="tab-materiais" data-tab="solicitacao-materiais"><i class="fas fa-envelope"></i> Solicitar Materiais</div>
                </div>

                <div class="tab-content-materiais active" id="consultar-materiais">
                    <div class="search-container-materiais">
                        <div class="search-bar-materiais">
                            <div class="search-input-container-materiais">
                                <input type="text" id="searchInputMateriais" placeholder="Pesquisar por c√≥digo, descri√ß√£o ou observa√ß√µes...">
                                <button class="clear-search-materiais" id="clearSearchMateriais" title="Limpar pesquisa">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <select id="categoryFilterMateriais">
                                <option value="">Todas as categorias</option>
                            </select>
                            <button id="searchButtonMateriais" class="btn-primary-materiais"><i class="fas fa-search"></i> Pesquisar</button>
                        </div>
                    </div>

                    <div class="selection-controls">
                        <div class="select-all">
                            <input type="checkbox" id="selectAllMateriais">
                            <label for="selectAllMateriais">Selecionar todos</label>
                        </div>
                        <div class="selection-info" id="selectionInfoMateriais">Nenhum item selecionado</div>
                        <button class="copy-btn" id="copySelectedMateriais" disabled>
                            <i class="fas fa-copy"></i> Copiar Selecionados
                        </button>
                        <!-- CORRE√á√ÉO: Bot√£o Solicitar adicionado -->
                        <button class="btn-primary-materiais" id="btn-solicitar-materiais" disabled>
                            <i class="fas fa-envelope"></i> Solicitar Selecionados
                        </button>
                    </div>

                    <div id="resultsContainerMateriais">
                        <table id="resultsTableMateriais">
                            <thead>
                                <tr>
                                    <th width="50px"></th>
                                    <th>C√≥digo</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Observa√ß√µes</th>
                                    <th>Categoria</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBodyMateriais">
                                <tr>
                                    <td colspan="6" class="no-results-materiais">
                                        <i class="fas fa-spinner fa-spin"></i> Carregando materiais...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="pagination" id="paginationMateriais"></div>
                    </div>
                </div>

                <div class="tab-content-materiais" id="cadastrar-materiais">
                    <div class="form-container-materiais">
                        <h2 class="form-title-materiais" id="formTitleMateriais"><i class="fas fa-plus-circle"></i> Cadastrar Novo Material</h2>
                        <form id="materialForm">
                            <div class="form-row-materiais">
                                <div class="form-group-materiais">
                                    <label for="codigo" class="required">C√≥digo *</label>
                                    <input type="text" id="codigo" required>
                                    <div class="validation-error-materiais" id="codigoError">C√≥digo j√° existe ou √© inv√°lido</div>
                                </div>
                                
                                <div class="form-group-materiais">
                                    <label for="categoria" class="required">Categoria *</label>
                                    <select id="categoria" required>
                                        <option value="">Selecione uma categoria</option>
                                    </select>
                                    <div class="validation-error-materiais" id="categoriaError">Selecione uma categoria v√°lida</div>
                                </div>
                            </div>
                            
                            <div class="form-group-materiais">
                                <label for="descricao" class="required">Descri√ß√£o do Produto *</label>
                                <input type="text" id="descricao" required>
                                <div class="validation-error-materiais" id="descricaoError">Descri√ß√£o √© obrigat√≥ria</div>
                            </div>
                            
                            <div class="form-group-materiais">
                                <label for="observacoes">Observa√ß√µes</label>
                                <textarea id="observacoes"></textarea>
                            </div>
                            
                            <div class="form-actions-materiais">
                                <button type="button" class="btn-secondary-materiais" id="cancelButtonMateriais">Cancelar</button>
                                <button type="submit" class="btn-primary-materiais" id="submitButtonMateriais"><i class="fas fa-save"></i> Cadastrar Material</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="tab-content-materiais" id="categorias-materiais">
                    <div class="form-container-materiais">
                        <h2 class="form-title-materiais"><i class="fas fa-tags"></i> Gerenciar Categorias</h2>
                        <div class="form-row-materiais">
                            <div class="form-group-materiais">
                                <label for="novaCategoria">Nova Categoria</label>
                                <input type="text" id="novaCategoria" placeholder="Digite o nome da nova categoria">
                            </div>
                            <div class="form-group-materiais">
                                <label>&nbsp;</label>
                                <button class="btn-primary-materiais" id="addCategoria"><i class="fas fa-plus"></i> Adicionar Categoria</button>
                            </div>
                        </div>
                        
                        <h3 style="margin: 20px 0 10px 0;">Categorias Existentes</h3>
                        <div id="categoriasList">
                            <p>Carregando categorias...</p>
                        </div>
                    </div>
                </div>

                <div class="tab-content-materiais" id="solicitacao-materiais">
                    <div class="form-container-materiais">
                        <h2 class="form-title-materiais"><i class="fas fa-envelope"></i> Solicita√ß√£o de Materiais</h2>
                        
                        <div class="solicitacao-container">
                            <div class="solicitacao-itens">
                                <h3>Itens Selecionados para Solicita√ß√£o</h3>
                                <div class="selection-controls">
                                    <div class="selection-info" id="solicitacaoSelectionInfo">Nenhum item selecionado</div>
                                </div>
                                <div id="solicitacaoResultsContainer">
                                    <table id="solicitacaoResultsTable">
                                        <thead>
                                            <tr>
                                                <th width="50px"></th>
                                                <th width="100px">Quantidade</th>
                                                <th>C√≥digo</th>
                                                <th>Descri√ß√£o</th>
                                                <th>Categoria</th>
                                            </tr>
                                        </thead>
                                        <tbody id="solicitacaoResultsBody">
                                            <!-- Os dados ser√£o inseridos aqui via JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="solicitacao-form">
                                <div class="form-group-materiais">
                                    <label for="tecnico" class="required">T√©cnico</label>
                                    <select id="tecnico" required>
                                        <option value="">Selecione o t√©cnico</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-materiais">
                                    <label>Pr√©via do Email</label>
                                    <div class="email-preview">
                                        <h4>Assunto: <span id="emailAssunto">Solicita√ß√£o de material - </span></h4>
                                        <div class="email-preview-content" id="emailPreview">
                                            Selecione um t√©cnico e itens para visualizar o email.
                                        </div>
                                    </div>
                                </div>
                                
                                <button class="btn-outlook" id="enviarOutlook" disabled>
                                    <i class="fas fa-paper-plane"></i> Abrir no Outlook
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast para notifica√ß√µes -->
    <div id="toast" class="toast"></div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://tfdniuwqjqvscwiypbuo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmZG5pdXdxanF2c2N3aXlwYnVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MjU1OTgsImV4cCI6MjA3NzUwMTU5OH0.ZeIef1hnlE4W10xD8Z23hiNEoOTdseNj_ox13uqchA0';
        const TABELA_COORDENADAS = 'coordenadas';
        const TABELA_CAIXAS = 'cx_disponiveis';
        const TABELA_MATERIAIS = 'materiais';
        const TABELA_CATEGORIAS = 'categorias';
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Vari√°veis globais
        let usuarioLogado = null;
        
        // Vari√°veis do sistema de coordenadas
        let tiposDeLocalCache = [];
        let paginaAtual = 1;
        const itensPorPagina = 10;
        let coordenadasFiltradas = [];
        let itemPesquisadoIndex = -1;
        let modoPesquisaContexto = false;
        let coordenadasSelecionadas = [];
        let colunaIdCoordenadas = null;

        // Vari√°veis do sistema de caixas
        let caixasSelecionadas = [];

        // Vari√°veis do sistema de materiais
        let materiais = [];
        let categorias = [];
        let editandoMaterial = false;
        let codigoEditando = null;
        let editandoCategoriaIndex = null;
        let currentPageMateriais = 1;
        const itemsPerPageMateriais = 10;
        let searchTimeoutMateriais;
        let selectedItemsMateriais = new Set();
        let solicitacaoItemsMateriais = new Map();

        // Lista de t√©cnicos para solicita√ß√£o de materiais
        const tecnicos = [
            "Adilson de Oliveira",
            "Rodrigo de Lima Vicente",
            "Dhiobert dos Santos Bertolino",
            "Vagner Cesar da Silva",
            "Weksley de Oliveira Queiroz",
            "Wellington da Silva de Souza",
            "Erman de Souza dos Santos",
            "M√°rio S√©rgio Rezende da Silva",
            "Daniel Fernando Filipe Quirino",
            "Ramom da Silva Moreira",
            "Calebe de Andrade Garcia",
            "La√©rcio Silva Rosa",
            "Pablo da Silva Veloso",
            "Jonatan de Souza Nascimento",
            "Geremias de Moura Vieira",
            "Douglas Silva Falc√£o",
            "Ailton J√∫nior da Silva Moreira",
            "Josiel Moreira da Silva",
            "Cosme Jos√© Alves",
            "Felipe Coste Dias",
            "Daniel Moura",
            "Marcelo",
            "Jackson Sampaio de Souza",
            "Igor",
            "Vinicius dos Santos Oliveira",
            "Geovani Silv√©rio De Andrade",
            "FHM Telecom",
            "TurboNet"
        ];

        // =============================================
        // SISTEMA DE LOGS - FUN√á√ïES COMPLETAS
        // =============================================

        // Fun√ß√£o para registrar logs no sistema
        async function registrarLog(usuario, tipo, mensagem, modulo = 'Sistema', detalhes = null) {
            try {
                const logData = {
                    usuario: usuario,
                    tipo: tipo,
                    mensagem: mensagem,
                    modulo: modulo,
                    detalhes: detalhes,
                    data_hora: new Date().toISOString(),
                    ip: await obterIPUsuario() // Tentar obter IP do usu√°rio
                };

                const { data, error } = await supabase
                    .from('logs_sistema')
                    .insert([logData]);

                if (error) {
                    console.error('‚ùå Erro ao registrar log:', error);
                } else {
                    console.log('‚úÖ Log registrado com sucesso:', logData);
                }
            } catch (error) {
                console.error('‚ùå Erro ao registrar log:', error);
            }
        }

        // Fun√ß√£o para obter IP do usu√°rio (simplificada)
        async function obterIPUsuario() {
            try {
                // Esta √© uma implementa√ß√£o simplificada
                // Em um ambiente real, voc√™ obteria o IP do servidor
                return '127.0.0.1'; // IP local como fallback
            } catch (error) {
                return 'IP n√£o dispon√≠vel';
            }
        }

        // =============================================
        // INICIALIZA√á√ÉO DO SISTEMA
        // =============================================

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando sistema de gest√£o de redes...');
            inicializarSistema();
        });

        // Inicializar sistema
        async function inicializarSistema() {
            try {
                mostrarStatusSetup('üîç Verificando configura√ß√£o do sistema...');
                
                // Verificar se podemos acessar o banco
                const bancoAcessivel = await verificarAcessoBanco();
                
                if (bancoAcessivel) {
                    mostrarStatusSetup('‚úÖ Banco de dados acess√≠vel! Verificando usu√°rio administrador...');
                    
                    // Verificar e corrigir o usu√°rio admin se necess√°rio
                    await verificarECorrigirUsuarioAdmin();
                    
                    mostrarStatusSetup('‚úÖ Sistema pronto! Voc√™ pode fazer login.');
                } else {
                    mostrarStatusSetup('‚ùå N√£o foi poss√≠vel acessar o banco de dados. Verifique a conex√£o.');
                }
                
                // Configurar event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o do sistema:', error);
                mostrarAlertaLogin('Erro ao inicializar sistema: ' + error.message);
            }
        }

        // Verificar acesso ao banco
        async function verificarAcessoBanco() {
            try {
                // Tentar uma consulta simples para verificar se a tabela existe
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('count')
                    .limit(1);

                if (error) {
                    console.error('‚ùå Erro ao acessar banco:', error);
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao verificar acesso ao banco:', error);
                return false;
            }
        }

        // Verificar e corrigir usu√°rio admin
        async function verificarECorrigirUsuarioAdmin() {
            try {
                console.log('üë§ Verificando usu√°rio administrador...');
                
                // Buscar usu√°rio admin
                const { data: usuarioExistente, error: erroBusca } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('email', 'admin@sistema.com')
                    .single();

                if (erroBusca && erroBusca.code === 'PGRST116') {
                    // Usu√°rio n√£o existe, vamos criar
                    console.log('‚ûï Criando usu√°rio administrador...');
                    await criarUsuarioAdmin();
                } else if (erroBusca) {
                    console.error('‚ùå Erro ao buscar usu√°rio:', erroBusca);
                    throw erroBusca;
                } else {
                    console.log('‚úÖ Usu√°rio administrador encontrado');
                    
                    // Verificar se a senha est√° correta
                    const senhaCorreta = await verificarSenhaUsuario(usuarioExistente);
                    if (!senhaCorreta) {
                        console.log('üîß Corrigindo senha do usu√°rio administrador...');
                        await corrigirSenhaUsuario(usuarioExistente.id);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar/corrigir usu√°rio admin:', error);
                throw error;
            }
        }

        // Verificar senha do usu√°rio
        async function verificarSenhaUsuario(usuario) {
            try {
                const senhaTeste = 'Kowa2013';
                const senhaCriptografada = CryptoJS.SHA256(senhaTeste).toString();
                return usuario.senha === senhaCriptografada;
            } catch (error) {
                console.error('‚ùå Erro ao verificar senha:', error);
                return false;
            }
        }

        // Corrigir senha do usu√°rio
        async function corrigirSenhaUsuario(usuarioId) {
            try {
                const senhaCorreta = 'Kowa2013';
                const senhaCriptografada = CryptoJS.SHA256(senhaCorreta).toString();
                
                const { error } = await supabase
                    .from('usuarios')
                    .update({ senha: senhaCriptografada })
                    .eq('id', usuarioId);

                if (error) {
                    throw error;
                }
                
                console.log('‚úÖ Senha do usu√°rio administrador corrigida!');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao corrigir senha:', error);
                throw error;
            }
        }

        // Criar usu√°rio administrador
        async function criarUsuarioAdmin() {
            try {
                console.log('‚ûï Criando usu√°rio administrador...');
                
                // Calcular o hash SHA256 correto para "Kowa2013"
                const senhaCorreta = 'Kowa2013';
                const senhaCriptografada = CryptoJS.SHA256(senhaCorreta).toString();
                
                console.log('üîë Hash SHA256 da senha:', senhaCriptografada);
                
                const usuarioAdmin = {
                    nome: 'Administrador',
                    email: 'admin@sistema.com',
                    senha: senhaCriptografada,
                    hierarquia: 'Administrador',
                    status: 'ativo',
                    data_cadastro: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('usuarios')
                    .insert([usuarioAdmin])
                    .select()
                    .single();

                if (error) {
                    console.error('‚ùå Erro ao criar usu√°rio admin:', error);
                    throw new Error('N√£o foi poss√≠vel criar o usu√°rio administrador: ' + error.message);
                }

                console.log('‚úÖ Usu√°rio administrador criado com sucesso!');
                console.log('üìß Email: admin@sistema.com');
                console.log('üîë Senha: Kowa2013');
                console.log('üîê Hash: ' + senhaCriptografada);
                
                // Registrar log do sistema
                await registrarLog('Sistema', 'security', 'Usu√°rio administrador criado', 'Sistema', 'Configura√ß√£o inicial do sistema');
                
                return data;
                
            } catch (error) {
                console.error('‚ùå Erro ao criar usu√°rio admin:', error);
                throw error;
            }
        }

        // Mostrar status do setup
        function mostrarStatusSetup(mensagem) {
            const setupStatus = document.getElementById('setup-status');
            if (setupStatus) {
                setupStatus.textContent = mensagem;
                setupStatus.classList.remove('hidden');
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            const loginForm = document.getElementById('login-form');
            
            if (loginForm) {
                loginForm.addEventListener('submit', fazerLogin);
            }
        }

        // Fazer login
        async function fazerLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const senha = document.getElementById('login-password').value;
            const loginButton = document.getElementById('login-button');
            
            if (!email || !senha) {
                mostrarAlertaLogin('Preencha todos os campos');
                return;
            }

            // Mostrar loading
            if (loginButton) {
                loginButton.disabled = true;
                loginButton.textContent = 'Entrando...';
            }

            try {
                console.log('üîê Tentando login...');
                
                // Buscar usu√°rio no Supabase
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (error) {
                    console.error('‚ùå Erro ao buscar usu√°rio:', error);
                    
                    if (error.code === 'PGRST116') {
                        throw new Error('Usu√°rio n√£o encontrado');
                    }
                    throw error;
                }
                
                console.log('üë§ Usu√°rio encontrado:', data);
                
                // Verificar status
                if (data.status !== 'ativo') {
                    throw new Error('Usu√°rio inativo. Contate o administrador.');
                }
                
                // Verificar senha
                const senhaCriptografada = CryptoJS.SHA256(senha).toString();
                
                if (data.senha !== senhaCriptografada) {
                    throw new Error('Senha incorreta');
                }
                
                // Login bem-sucedido
                usuarioLogado = data;
                localStorage.setItem('usuario_logado', JSON.stringify(data));
                
                console.log('‚úÖ Login realizado com sucesso');
                
                // REGISTRAR LOG DE LOGIN
                await registrarLog(usuarioLogado.nome, 'security', 'Login realizado no sistema', 'Autentica√ß√£o', `Usu√°rio: ${usuarioLogado.email}`);
                
                mostrarSistemaPrincipal();
                
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                mostrarAlertaLogin(error.message);
                
                // Registrar tentativa de login falha
                await registrarLog(email, 'error', 'Tentativa de login falhou', 'Autentica√ß√£o', error.message);
            } finally {
                // Restaurar bot√£o
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.textContent = 'Entrar';
                }
            }
        }

        // Mostrar alerta de login
        function mostrarAlertaLogin(mensagem) {
            const loginAlert = document.getElementById('login-alert');
            if (loginAlert) {
                loginAlert.textContent = mensagem;
                loginAlert.classList.remove('hidden');
                
                setTimeout(() => {
                    loginAlert.classList.add('hidden');
                }, 5000);
            }
        }

        // Mostrar sistema principal
        function mostrarSistemaPrincipal() {
            console.log('üéØ Mostrando sistema principal...');
            
            const loginPage = document.getElementById('login-page');
            const mainSystem = document.getElementById('main-system');
            
            if (loginPage && mainSystem) {
                // Ocultar login
                loginPage.classList.add('hidden');
                
                // Mostrar sistema principal
                mainSystem.classList.remove('hidden');
                
                // Atualizar interface com dados do usu√°rio
                atualizarInterfaceUsuario();
                
                // CORRE√á√ÉO: Preencher campo de usu√°rio nas caixas
                const usuarioCadastroInput = document.getElementById('usuario-cadastro');
                if (usuarioCadastroInput && usuarioLogado) {
                    usuarioCadastroInput.value = usuarioLogado.nome;
                }
                
                console.log('‚úÖ Sistema principal carregado com sucesso!');
            } else {
                console.error('‚ùå Elementos n√£o encontrados');
            }
        }

        // Atualizar interface com dados do usu√°rio
        function atualizarInterfaceUsuario() {
            if (!usuarioLogado) return;
            
            // Atualizar informa√ß√µes do usu√°rio
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const userRole = document.getElementById('user-role');
            const welcomeMessage = document.getElementById('welcome-message');
            const userRoleBadge = document.getElementById('user-role-badge');
            const loginUser = document.getElementById('login-user');
            const loginTime = document.getElementById('login-time');
            
            if (userAvatar) userAvatar.textContent = usuarioLogado.nome.charAt(0).toUpperCase();
            if (userName) userName.textContent = usuarioLogado.nome;
            if (userRole) userRole.textContent = usuarioLogado.hierarquia;
            if (welcomeMessage) welcomeMessage.textContent = `Bem-vindo, ${usuarioLogado.nome}!`;
            if (userRoleBadge) {
                userRoleBadge.textContent = usuarioLogado.hierarquia;
                userRoleBadge.className = `role-badge role-${usuarioLogado.hierarquia.toLowerCase().replace('√£', 'a').replace('√ß', 'c')}`;
            }
            if (loginUser) loginUser.textContent = usuarioLogado.nome;
            if (loginTime) loginTime.textContent = new Date().toLocaleString('pt-BR');
            
            // Configurar event listeners do sistema
            configurarEventListenersSistema();
        }

        // FUN√á√ïES DE NAVEGA√á√ÉO E P√ÅGINAS
        function configurarEventListenersSistema() {
            // Logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    // REGISTRAR LOG DE LOGOUT
                    if (usuarioLogado) {
                        await registrarLog(usuarioLogado.nome, 'security', 'Logout realizado', 'Autentica√ß√£o');
                    }
                    
                    usuarioLogado = null;
                    localStorage.removeItem('usuario_logado');
                    location.reload();
                });
            }

            // Navega√ß√£o entre p√°ginas
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    navegarParaPagina(this.id.replace('nav-', ''));
                });
            });

            // Configurar sistema de coordenadas
            configurarSistemaCoordenadas();

            // Configurar sistema de materiais
            configurarSistemaMateriais();

            // Configurar sistema de usu√°rios
            configurarBotaoNovoUsuario();

            // Carregar dados iniciais
            carregarUsuarios();
        }

        function navegarParaPagina(pagina) {
            // Atualizar navega√ß√£o
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.getElementById(`nav-${pagina}`).classList.add('active');

            // Mostrar p√°gina correspondente
            document.querySelectorAll('.page-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`page-${pagina}`).classList.add('active');

            // Carregar dados espec√≠ficos da p√°gina se necess√°rio
            switch(pagina) {
                case 'usuarios':
                    carregarUsuarios();
                    break;
                case 'coordenadas':
                    // CORRE√á√ÉO: Preencher campo de usu√°rio ao acessar coordenadas (que cont√©m a aba de caixas)
                    const usuarioCadastroInput = document.getElementById('usuario-cadastro');
                    if (usuarioCadastroInput && usuarioLogado) {
                        usuarioCadastroInput.value = usuarioLogado.nome;
                    }
                    carregarCoordenadas();
                    break;
                case 'materiais':
                    inicializarSistemaMateriais();
                    break;
            }
        }

        // =============================================
        // SISTEMA DE USU√ÅRIOS - FUN√á√ïES CORRIGIDAS
        // =============================================

        // FUN√á√ïES PARA USU√ÅRIOS - CORRIGIDAS
        async function carregarUsuarios() {
            try {
                const { data: usuarios, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .order('data_cadastro', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('tbody-usuarios');
                if (usuarios && usuarios.length > 0) {
                    tbody.innerHTML = usuarios.map(usuario => `
                        <tr>
                            <td>${usuario.nome}</td>
                            <td>${usuario.email}</td>
                            <td><span class="role-badge role-${usuario.hierarquia.toLowerCase().replace('√£', 'a').replace('√ß', 'c')}">${usuario.hierarquia}</span></td>
                            <td><span class="status-badge status-${usuario.status}">${usuario.status}</span></td>
                            <td>${new Date(usuario.data_cadastro).toLocaleDateString('pt-BR')}</td>
                            <td class="actions">
                                <button class="action-btn btn-info" onclick="editarUsuario(${usuario.id})">Editar</button>
                                <button class="action-btn btn-danger" onclick="excluirUsuario(${usuario.id})">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                    
                    // Atualizar estat√≠sticas
                    document.getElementById('total-usuarios').textContent = usuarios.length;
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div>üë•</div>
                                <p>Nenhum usu√°rio cadastrado</p>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                mostrarToast('Erro ao carregar usu√°rios: ' + error.message, 'erro');
            }
        }

        // Configurar bot√£o novo usu√°rio
        function configurarBotaoNovoUsuario() {
            const btnNovoUsuario = document.getElementById('btn-novo-usuario');
            if (btnNovoUsuario) {
                btnNovoUsuario.addEventListener('click', function() {
                    abrirModalUsuario();
                });
            }
        }

        // Abrir modal para criar/editar usu√°rio
        function abrirModalUsuario(usuario = null) {
            // Criar modal dinamicamente se n√£o existir
            let modal = document.getElementById('modal-usuario');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modal-usuario';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" id="modal-usuario-titulo">Novo Usu√°rio</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <form id="form-usuario">
                            <input type="hidden" id="usuario-id" name="usuario-id">
                            
                            <div class="form-group">
                                <label for="usuario-nome" class="required">Nome *</label>
                                <input type="text" id="usuario-nome" name="usuario-nome" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="usuario-email" class="required">Email *</label>
                                <input type="email" id="usuario-email" name="usuario-email" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="usuario-senha" class="${usuario ? '' : 'required'}">Senha ${usuario ? '(deixe em branco para manter atual)' : '*'} </label>
                                <input type="password" id="usuario-senha" name="usuario-senha" ${usuario ? '' : 'required'}>
                            </div>
                            
                            <div class="form-group">
                                <label for="usuario-hierarquia" class="required">Hierarquia *</label>
                                <select id="usuario-hierarquia" name="usuario-hierarquia" required>
                                    <option value="">Selecione uma hierarquia</option>
                                    <option value="Administrador">Administrador</option>
                                    <option value="Supervis√£o">Supervis√£o</option>
                                    <option value="Analistas">Analistas</option>
                                    <option value="T√©cnico">T√©cnico</option>
                                    <option value="Projetos">Projetos</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="usuario-status" class="required">Status *</label>
                                <select id="usuario-status" name="usuario-status" required>
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                </select>
                            </div>
                            
                            <div class="modal-footer">
                                <button type="button" class="btn-danger" id="btn-cancelar-usuario">Cancelar</button>
                                <button type="submit" class="btn-success" id="btn-salvar-usuario">Salvar Usu√°rio</button>
                            </div>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Configurar event listeners do modal
                configurarModalUsuario();
            }
            
            // Preencher dados se for edi√ß√£o
            if (usuario) {
                document.getElementById('modal-usuario-titulo').textContent = 'Editar Usu√°rio';
                document.getElementById('usuario-id').value = usuario.id;
                document.getElementById('usuario-nome').value = usuario.nome;
                document.getElementById('usuario-email').value = usuario.email;
                document.getElementById('usuario-hierarquia').value = usuario.hierarquia;
                document.getElementById('usuario-status').value = usuario.status;
                document.getElementById('usuario-senha').required = false;
            } else {
                document.getElementById('modal-usuario-titulo').textContent = 'Novo Usu√°rio';
                document.getElementById('form-usuario').reset();
                document.getElementById('usuario-id').value = '';
                document.getElementById('usuario-senha').required = true;
            }
            
            modal.style.display = 'flex';
        }

        // Configurar modal de usu√°rio
        function configurarModalUsuario() {
            const modal = document.getElementById('modal-usuario');
            const closeBtn = modal.querySelector('.close-modal');
            const cancelBtn = modal.querySelector('#btn-cancelar-usuario');
            const form = modal.querySelector('#form-usuario');
            
            // Fechar modal
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            cancelBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            // Fechar ao clicar fora do modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Submeter formul√°rio
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                await salvarUsuario();
            });
        }

        // Salvar usu√°rio (criar ou editar)
        async function salvarUsuario() {
            const modal = document.getElementById('modal-usuario');
            const form = document.getElementById('form-usuario');
            
            const usuarioId = document.getElementById('usuario-id').value;
            const nome = document.getElementById('usuario-nome').value;
            const email = document.getElementById('usuario-email').value;
            const senha = document.getElementById('usuario-senha').value;
            const hierarquia = document.getElementById('usuario-hierarquia').value;
            const status = document.getElementById('usuario-status').value;
            
            if (!nome || !email || !hierarquia || !status) {
                mostrarToast('Preencha todos os campos obrigat√≥rios', 'erro');
                return;
            }
            
            // Verificar se √© edi√ß√£o ou cria√ß√£o
            const editando = !!usuarioId;
            
            try {
                let dadosUsuario = {
                    nome: nome,
                    email: email,
                    hierarquia: hierarquia,
                    status: status
                };
                
                // Se for nova senha, criptografar
                if (senha) {
                    dadosUsuario.senha = CryptoJS.SHA256(senha).toString();
                }
                
                let resultado;
                
                if (editando) {
                    // Atualizar usu√°rio existente
                    const { data, error } = await supabase
                        .from('usuarios')
                        .update(dadosUsuario)
                        .eq('id', usuarioId)
                        .select();
                    
                    if (error) throw error;
                    resultado = data;
                    
                    // REGISTRAR LOG DE EDI√á√ÉO DE USU√ÅRIO
                    await registrarLog(usuarioLogado.nome, 'info', 'Usu√°rio atualizado', 'Usu√°rios', `ID: ${usuarioId}, Nome: ${nome}, Email: ${email}, Hierarquia: ${hierarquia}, Status: ${status}`);
                } else {
                    // Criar novo usu√°rio
                    // Verificar se email j√° existe
                    const { data: usuarioExistente, error: erroBusca } = await supabase
                        .from('usuarios')
                        .select('id')
                        .eq('email', email)
                        .single();
                    
                    if (usuarioExistente) {
                        mostrarToast('J√° existe um usu√°rio com este email', 'erro');
                        return;
                    }
                    
                    // Adicionar data de cadastro para novo usu√°rio
                    dadosUsuario.data_cadastro = new Date().toISOString();
                    
                    const { data, error } = await supabase
                        .from('usuarios')
                        .insert([dadosUsuario])
                        .select();
                    
                    if (error) throw error;
                    resultado = data;
                    
                    // REGISTRAR LOG DE CRIA√á√ÉO DE USU√ÅRIO
                    await registrarLog(usuarioLogado.nome, 'info', 'Novo usu√°rio criado', 'Usu√°rios', `Nome: ${nome}, Email: ${email}, Hierarquia: ${hierarquia}, Status: ${status}`);
                }
                
                mostrarToast(`Usu√°rio ${editando ? 'atualizado' : 'criado'} com sucesso!`);
                
                // Fechar modal e recarregar lista
                modal.style.display = 'none';
                await carregarUsuarios();
                
            } catch (error) {
                console.error('Erro ao salvar usu√°rio:', error);
                mostrarToast('Erro ao salvar usu√°rio: ' + error.message, 'erro');
                
                // REGISTRAR LOG DE ERRO
                await registrarLog(usuarioLogado.nome, 'error', 'Erro ao salvar usu√°rio', 'Usu√°rios', error.message);
            }
        }

        // Editar usu√°rio - FUN√á√ÉO CORRIGIDA
        async function editarUsuario(id) {
            try {
                // Buscar dados do usu√°rio
                const { data: usuario, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Abrir modal de edi√ß√£o
                abrirModalUsuario(usuario);
                
            } catch (error) {
                console.error('Erro ao buscar usu√°rio:', error);
                mostrarToast('Erro ao carregar dados do usu√°rio: ' + error.message, 'erro');
            }
        }

        // Excluir usu√°rio
        async function excluirUsuario(id) {
            // N√£o permitir excluir o pr√≥prio usu√°rio
            if (usuarioLogado && usuarioLogado.id === id) {
                mostrarToast('Voc√™ n√£o pode excluir sua pr√≥pria conta', 'erro');
                return;
            }
            
            if (confirm('Tem certeza que deseja excluir este usu√°rio?')) {
                try {
                    // Buscar dados do usu√°rio antes de excluir para registrar no log
                    const { data: usuario, error: erroBusca } = await supabase
                        .from('usuarios')
                        .select('*')
                        .eq('id', id)
                        .single();
                    
                    const { error } = await supabase
                        .from('usuarios')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    // REGISTRAR LOG DE EXCLUS√ÉO DE USU√ÅRIO
                    if (usuario) {
                        await registrarLog(usuarioLogado.nome, 'warning', 'Usu√°rio exclu√≠do', 'Usu√°rios', `ID: ${id}, Nome: ${usuario.nome}, Email: ${usuario.email}`);
                    }
                    
                    mostrarToast('Usu√°rio exclu√≠do com sucesso!');
                    carregarUsuarios();
                } catch (error) {
                    console.error('Erro ao excluir usu√°rio:', error);
                    mostrarToast('Erro ao excluir usu√°rio: ' + error.message, 'erro');
                    
                    // REGISTRAR LOG DE ERRO
                    await registrarLog(usuarioLogado.nome, 'error', 'Erro ao excluir usu√°rio', 'Usu√°rios', error.message);
                }
            }
        }

        // =============================================
        // SISTEMA DE COORDENADAS - FUN√á√ïES CORRIGIDAS
        // =============================================

        // Configurar sistema de coordenadas
        function configurarSistemaCoordenadas() {
            // Event listeners espec√≠ficos do sistema de coordenadas
            const btnCopiar = document.getElementById('btn-copiar');
            const btnExcluirCoordenadas = document.getElementById('btn-excluir-coordenadas');
            const searchInput = document.getElementById('search-input');
            const tipoLocalSelect = document.getElementById('tipo-local-select');
            const btnLimparPesquisa = document.getElementById('btn-limpar-pesquisa');

            // Abas de navega√ß√£o
            const abaConsulta = document.getElementById('aba-consulta');
            const abaCaixas = document.getElementById('aba-caixas');

            if (abaConsulta) {
                abaConsulta.addEventListener('click', function() {
                    alternarAba('consulta');
                });
            }

            if (abaCaixas) {
                abaCaixas.addEventListener('click', function() {
                    alternarAba('caixas');
                });
            }

            if (btnCopiar) {
                btnCopiar.addEventListener('click', copiarItensSelecionados);
            }

            if (btnExcluirCoordenadas) {
                btnExcluirCoordenadas.addEventListener('click', function() {
                    if (coordenadasSelecionadas.length === 0) {
                        mostrarToast('Por favor, selecione pelo menos uma coordenada para excluir.', 'erro');
                        return;
                    }

                    const coordenadasSelecionadasNomes = [];
                    coordenadasSelecionadas.forEach(id => {
                        const checkbox = document.querySelector(`.item-checkbox[data-id="${id}"]`);
                        if (checkbox) {
                            const nome = checkbox.getAttribute('data-nome');
                            coordenadasSelecionadasNomes.push(nome);
                        }
                    });

                    if (confirm(`Tem certeza que deseja excluir as seguintes coordenadas?\n\n${coordenadasSelecionadasNomes.join('\n')}`)) {
                        excluirMultiplasCoordenadas(coordenadasSelecionadas);
                    }
                });
            }

            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function() {
                        const termo = searchInput.value.trim();
                        if (termo) {
                            atualizarTabela(termo);
                        } else {
                            modoPesquisaContexto = false;
                            itemPesquisadoIndex = -1;
                            atualizarTabela('');
                        }
                    }, 500);
                });
            }

            if (tipoLocalSelect) {
                let searchTimeout;
                tipoLocalSelect.addEventListener('change', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function() {
                        const termo = searchInput.value.trim();
                        atualizarTabela(termo);
                    }, 300);
                });
            }

            if (btnLimparPesquisa) {
                btnLimparPesquisa.addEventListener('click', function() {
                    searchInput.value = '';
                    tipoLocalSelect.value = '';
                    paginaAtual = 1;
                    modoPesquisaContexto = false;
                    itemPesquisadoIndex = -1;
                    atualizarTabela();
                });
            }

            // Configurar sistema de caixas
            configurarSistemaCaixas();

            // Inicializar sistema de coordenadas
            inicializarSistemaCoordenadas();
        }

        // Alternar entre abas
        function alternarAba(aba) {
            // Atualizar abas
            document.querySelectorAll('.aba').forEach(a => a.classList.remove('active'));
            document.querySelectorAll('.conteudo-aba').forEach(c => c.classList.remove('active'));
            
            document.getElementById(`aba-${aba}`).classList.add('active');
            document.getElementById(`conteudo-${aba}`).classList.add('active');
            
            // Carregar dados espec√≠ficos da aba
            if (aba === 'consulta') {
                carregarCoordenadas();
            } else if (aba === 'caixas') {
                // CORRE√á√ÉO: Preencher campo de usu√°rio ao acessar a aba
                const usuarioCadastroInput = document.getElementById('usuario-cadastro');
                if (usuarioCadastroInput && usuarioLogado) {
                    usuarioCadastroInput.value = usuarioLogado.nome;
                }
                atualizarListaCaixas();
            }
        }

        // Inicializar sistema de coordenadas
        async function inicializarSistemaCoordenadas() {
            console.log('üìç Inicializando sistema de coordenadas...');
            
            // Detectar a coluna de ID
            await descobrirColunaIdCoordenadas();
            
            // Carregar tipos de local
            await carregarTiposDeLocal();
        }

        // CORRE√á√ÉO: Fun√ß√£o otimizada para descobrir a coluna de ID
        async function descobrirColunaIdCoordenadas() {
            if (colunaIdCoordenadas) {
                return colunaIdCoordenadas;
            }
            
            try {
                console.log('üîç Detectando coluna de ID da tabela coordenadas...');
                
                const { data, error } = await supabase
                    .from(TABELA_COORDENADAS)
                    .select('*')
                    .limit(1);

                if (error) throw error;
                
                if (data && data.length > 0) {
                    const primeiraCoordenada = data[0];
                    console.log('Estrutura da coordenada:', primeiraCoordenada);
                    
                    const possiveisIds = ['id', 'ID', 'Id', 'codigo', 'cod', 'chave'];
                    for (const possivelId of possiveisIds) {
                        if (primeiraCoordenada.hasOwnProperty(possivelId)) {
                            console.log(`‚úÖ Coluna de ID encontrada: ${possivelId}`);
                            colunaIdCoordenadas = possivelId;
                            return possivelId;
                        }
                    }
                    
                    const primeiraChave = Object.keys(primeiraCoordenada)[0];
                    console.log(`‚ö†Ô∏è Usando primeira chave como ID: ${primeiraChave}`);
                    colunaIdCoordenadas = primeiraChave;
                    return primeiraChave;
                }
                
                console.warn('‚ùå N√£o foi poss√≠vel identificar a coluna de ID, usando "id" como padr√£o');
                colunaIdCoordenadas = 'id';
                return 'id';
            } catch (error) {
                console.error('‚ùå Erro ao identificar coluna de ID:', error);
                colunaIdCoordenadas = 'id';
                return 'id';
            }
        }

        // Fun√ß√£o para normalizar coordenadas (substituir v√≠rgula por ponto)
        function normalizarCoordenada(valor) {
            if (!valor) return '';
            return valor.toString().replace(',', '.');
        }

        // CORRE√á√ÉO: Validar se coordenada j√° existe (nome, latitude e longitude)
        async function validarCoordenadaDuplicada(nome, latitude, longitude) {
            try {
                // Normalizar coordenadas para compara√ß√£o
                const latNormalizada = normalizarCoordenada(latitude);
                const lngNormalizada = normalizarCoordenada(longitude);
                
                // Buscar coordenadas com mesmo nome OU mesma localiza√ß√£o
                const { data, error } = await supabase
                    .from(TABELA_COORDENADAS)
                    .select('*')
                    .or(`Nome.eq.${nome},and(Y.eq.${latNormalizada},X.eq.${lngNormalizada})`);

                if (error) {
                    console.error('‚ùå Erro ao validar coordenada:', error);
                    return false; // Em caso de erro, permitir o cadastro
                }

                if (data && data.length > 0) {
                    // Verificar se √© duplicata exata
                    const duplicata = data.find(coord => {
                        const coordLat = normalizarCoordenada(coord.Y);
                        const coordLng = normalizarCoordenada(coord.X);
                        return coord.Nome === nome || 
                               (coordLat === latNormalizada && coordLng === lngNormalizada);
                    });
                    
                    if (duplicata) {
                        if (duplicata.Nome === nome) {
                            mostrarToast(`J√° existe uma coordenada com o nome "${nome}"`, 'erro');
                        } else {
                            mostrarToast(`J√° existe uma coordenada com a localiza√ß√£o ${latNormalizada}, ${lngNormalizada}`, 'erro');
                        }
                        return true;
                    }
                }
                
                return false;
            } catch (error) {
                console.error('‚ùå Erro ao validar coordenada duplicada:', error);
                return false;
            }
        }

        // Fun√ß√µes de CRUD para Coordenadas
        async function obterTodasCoordenadas() {
            console.log('üîç Buscando TODOS os dados do Supabase...');
            
            let todasCoordenadas = [];
            let inicio = 0;
            const limite = 1000;
            let hasMore = true;
            
            try {
                while (hasMore) {
                    console.log(`üì• Buscando registros ${inicio} a ${inicio + limite - 1}...`);
                    
                    const { data, error } = await supabase
                        .from(TABELA_COORDENADAS)
                        .select('*')
                        .range(inicio, inicio + limite - 1);

                    if (error) {
                        console.error('Erro ao buscar coordenadas:', error);
                        break;
                    }

                    if (data && data.length > 0) {
                        todasCoordenadas = todasCoordenadas.concat(data);
                        console.log(`‚úÖ ${data.length} registros carregados. Total: ${todasCoordenadas.length}`);
                        
                        if (data.length < limite) {
                            hasMore = false;
                            console.log('üèÅ Todos os registros foram carregados.');
                        } else {
                            inicio += limite;
                        }
                    } else {
                        hasMore = false;
                        console.log('üèÅ Nenhum registro adicional encontrado.');
                    }
                }
                
                console.log(`‚úÖ ${todasCoordenadas.length} coordenadas carregadas no total`);
                return todasCoordenadas;
            } catch (error) {
                console.error('Erro ao buscar todas as coordenadas:', error);
                return [];
            }
        }

        async function obterCoordenadas() {
            document.getElementById('loading-coordenadas').classList.remove('hidden');
            document.getElementById('tabela-coordenadas').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('pagination-controls').classList.add('hidden');
            document.getElementById('pagination-info').classList.add('hidden');
            document.getElementById('stats-info').classList.add('hidden');
            
            try {
                const data = await obterTodasCoordenadas();
                console.log(`‚úÖ ${data ? data.length : 0} coordenadas carregadas`);
                
                const statsText = document.getElementById('stats-text');
                const total = data.length;
                if (statsText) {
                    statsText.innerHTML = `<strong>Total carregado:</strong> ${total} registros`;
                }
                
                return data || [];
            } catch (error) {
                console.error('Erro ao buscar coordenadas:', error);
                return [];
            } finally {
                document.getElementById('loading-coordenadas').classList.add('hidden');
            }
        }

        async function obterTiposDeLocal() {
            try {
                console.log('üîç Buscando tipos de local...');
                
                const data = await obterTodasCoordenadas();

                const tiposComContagem = {};
                
                data.forEach(item => {
                    const tipoLocal = item['Tipo de Local'] || item['tipo_local'] || item['Tipo_de_Local'] || item['tipo'] || item['Tipo'] || '';
                    if (tipoLocal && tipoLocal.trim() !== '') {
                        if (!tiposComContagem[tipoLocal]) {
                            tiposComContagem[tipoLocal] = 0;
                        }
                        tiposComContagem[tipoLocal]++;
                    }
                });
                
                const tiposArray = Object.keys(tiposComContagem).map(tipo => ({
                    tipo: tipo,
                    count: tiposComContagem[tipo]
                })).sort((a, b) => a.tipo.localeCompare(b.tipo));
                
                console.log(`‚úÖ ${tiposArray.length} tipos de local encontrados com contagem`);
                
                return tiposArray;
            } catch (error) {
                console.error('Erro ao buscar tipos de local:', error);
                return [];
            }
        }

        async function carregarTiposDeLocal() {
            const tipoLocalSelect = document.getElementById('tipo-local-select');
            
            try {
                const loadingOption = document.createElement('option');
                loadingOption.value = '';
                loadingOption.textContent = 'Carregando tipos...';
                tipoLocalSelect.innerHTML = '';
                tipoLocalSelect.appendChild(loadingOption);
                
                const tiposComContagem = await obterTiposDeLocal();
                const todasCoordenadas = await obterTodasCoordenadas();
                const totalTodos = todasCoordenadas.length;
                
                tipoLocalSelect.innerHTML = '';
                
                const optionTodos = document.createElement('option');
                optionTodos.value = '';
                optionTodos.innerHTML = `Todos os Tipos de Local <span class="option-count">(${totalTodos})</span>`;
                tipoLocalSelect.appendChild(optionTodos);
                
                tiposComContagem.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.tipo;
                    option.innerHTML = `${item.tipo} <span class="option-count">(${item.count})</span>`;
                    tipoLocalSelect.appendChild(option);
                });
                
                tiposDeLocalCache = tiposComContagem;
                
                console.log(`‚úÖ ${tiposComContagem.length} tipos de local carregados com contagem`);
            } catch (error) {
                console.error('Erro ao carregar tipos de local:', error);
                tipoLocalSelect.innerHTML = '<option value="">Todos os Tipos de Local</option>';
            }
        }

        // CORRE√á√ÉO: Fun√ß√£o para excluir m√∫ltiplas coordenadas usando a coluna de ID correta
        async function excluirMultiplasCoordenadas(ids) {
            try {
                const colunaId = await descobrirColunaIdCoordenadas();
                console.log(`üóëÔ∏è Excluindo coordenadas usando a coluna: ${colunaId}`);
                console.log(`üóëÔ∏è IDs para excluir:`, ids);
                
                // Buscar informa√ß√µes das coordenadas antes de excluir para registrar no log
                const { data: coordenadasInfo, error: erroBusca } = await supabase
                    .from(TABELA_COORDENADAS)
                    .select('*')
                    .in(colunaId, ids);

                const result = await supabase
                    .from(TABELA_COORDENADAS)
                    .delete()
                    .in(colunaId, ids)
                    .select();

                if (result.error) {
                    if (result.error.message.includes('row-level security policy')) {
                        console.error('‚ùå Erro de RLS detectado:', result.error);
                        mostrarToast('Erro de permiss√£o: A tabela est√° protegida por pol√≠ticas de seguran√ßa. Entre em contato com o administrador.', 'erro');
                    }
                    throw result.error;
                }
                
                // REGISTRAR LOG DE EXCLUS√ÉO DE COORDENADAS
                if (coordenadasInfo && coordenadasInfo.length > 0) {
                    const nomesCoordenadas = coordenadasInfo.map(coord => coord.Nome || 'Sem nome').join(', ');
                    await registrarLog(usuarioLogado.nome, 'warning', `${ids.length} coordenada(s) exclu√≠da(s)`, 'Coordenadas', `Coordenadas exclu√≠das: ${nomesCoordenadas}`);
                }
                
                mostrarToast(`‚úÖ ${ids.length} coordenada(s) exclu√≠da(s) com sucesso!`);
                atualizarTabela();
                return true;
            } catch (error) {
                console.error('Erro ao excluir coordenadas:', error);
                mostrarToast('Erro ao excluir coordenadas: ' + error.message, 'erro');
                
                // REGISTRAR LOG DE ERRO
                await registrarLog(usuarioLogado.nome, 'error', 'Erro ao excluir coordenadas', 'Coordenadas', error.message);
                return false;
            }
        }

        // CORRE√á√ÉO: Fun√ß√£o renderizarPagina para suportar pesquisa m√∫ltipla
        function renderizarPagina() {
            const tabelaCorpo = document.getElementById('tabela-corpo');
            const emptyState = document.getElementById('empty-state');
            const infoPesquisa = document.getElementById('info-pesquisa');
            
            let coordsPagina = [];
            let inicio = 0;
            let fim = 0;
            
            if (modoPesquisaContexto) {
                coordsPagina = coordenadasFiltradas;
                inicio = 1;
                fim = coordsPagina.length;
                
                if (infoPesquisa) {
                    const searchInput = document.getElementById('search-input');
                    const termos = processarTermosPesquisa(searchInput.value);
                    
                    infoPesquisa.innerHTML = `
                        <strong>üîç Modo de pesquisa m√∫ltipla:</strong> 
                        Mostrando os itens pesquisados com contexto (4 itens anteriores e 4 posteriores).
                        Os itens pesquisados est√£o destacados em amarelo.
                        <br><strong>Termos pesquisados:</strong> ${termos.join(', ')}
                        <br><strong>Total de itens no contexto:</strong> ${coordsPagina.length}
                        <br><strong>Itens encontrados:</strong> ${Array.isArray(itemPesquisadoIndex) ? itemPesquisadoIndex.length : 1}
                    `;
                    infoPesquisa.classList.remove('hidden');
                }
            } else {
                inicio = (paginaAtual - 1) * itensPorPagina;
                fim = inicio + itensPorPagina;
                coordsPagina = coordenadasFiltradas.slice(inicio, fim);
                
                if (infoPesquisa) {
                    infoPesquisa.classList.add('hidden');
                }
            }
            
            tabelaCorpo.innerHTML = '';
            
            if (coordsPagina.length === 0) {
                document.getElementById('tabela-coordenadas').classList.add('hidden');
                emptyState.classList.remove('hidden');
                document.getElementById('pagination-controls').classList.add('hidden');
                document.getElementById('pagination-info').classList.add('hidden');
                document.getElementById('stats-info').classList.add('hidden');
                if (infoPesquisa) infoPesquisa.classList.add('hidden');
                return;
            } else {
                document.getElementById('tabela-coordenadas').classList.remove('hidden');
                emptyState.classList.add('hidden');
            }
            
            const colunaId = colunaIdCoordenadas || 'id';
            
            coordsPagina.forEach((coord, index) => {
                const tr = document.createElement('tr');
                
                // CORRE√á√ÉO: Destacar m√∫ltiplos itens pesquisados no modo de contexto
                if (modoPesquisaContexto) {
                    if (Array.isArray(itemPesquisadoIndex)) {
                        // Pesquisa m√∫ltipla - destacar todos os itens encontrados
                        if (itemPesquisadoIndex.includes(index)) {
                            tr.classList.add('destaque-pesquisa');
                        }
                    } else {
                        // Pesquisa √∫nica (compatibilidade)
                        if (index === itemPesquisadoIndex) {
                            tr.classList.add('destaque-pesquisa');
                        }
                    }
                }
                
                const nome = coord.Nome || '';
                const tipoLocal = coord['Tipo de Local'] || coord['tipo_local'] || coord['Tipo_de_Local'] || coord['tipo'] || coord['Tipo'] || '';
                const latitude = normalizarCoordenada(coord.Y);
                const longitude = normalizarCoordenada(coord.X);
                const idCoordenada = coord[colunaId] || '';
                
                tr.innerHTML = `
                    <td class="checkbox-column">
                        <input type="checkbox" class="item-checkbox" data-id="${idCoordenada}" data-nome="${nome}" data-latitude="${latitude}" data-longitude="${longitude}">
                    </td>
                    <td>${nome}</td>
                    <td>${tipoLocal}</td>
                    <td>${latitude}</td>
                    <td>${longitude}</td>
                `;
                tabelaCorpo.appendChild(tr);
                
                const checkbox = tr.querySelector('.item-checkbox');
                checkbox.addEventListener('change', function() {
                    const coordId = this.getAttribute('data-id');
                    alternarSelecaoCoordenada(coordId, this.closest('tr'));
                });
            });
            
            if (!modoPesquisaContexto) {
                atualizarPaginacao();
            } else {
                document.getElementById('pagination-controls').classList.add('hidden');
                document.getElementById('pagination-info').classList.add('hidden');
                document.getElementById('stats-info').classList.remove('hidden');
                
                const paginationInfo = document.getElementById('pagination-info');
                if (paginationInfo) {
                    const totalItens = coordenadasFiltradas.length;
                    const searchInput = document.getElementById('search-input');
                    const termos = processarTermosPesquisa(searchInput.value);
                    
                    paginationInfo.textContent = `Modo pesquisa m√∫ltipla: ${termos.length} termo(s), ${coordsPagina.length} itens com contexto`;
                    paginationInfo.classList.remove('hidden');
                }
            }
        }

        // CORRE√á√ÉO: Fun√ß√£o para processar termos de pesquisa m√∫ltipla
        function processarTermosPesquisa(termoPesquisa) {
            if (!termoPesquisa) return [];
            
            // Separar por ponto e v√≠rgula e remover espa√ßos em branco
            const termos = termoPesquisa.split(';')
                .map(termo => termo.trim())
                .filter(termo => termo !== '');
            
            console.log(`üîç Termos de pesquisa processados:`, termos);
            return termos;
        }

        // CORRE√á√ÉO: Encontrar m√∫ltiplos itens pesquisados
        function encontrarItensPesquisados(coordenadas, termosPesquisa) {
            if (!termosPesquisa || termosPesquisa.length === 0) return [];
            
            const indicesEncontrados = [];
            
            termosPesquisa.forEach(termo => {
                const termoLower = termo.toLowerCase().trim();
                
                for (let i = 0; i < coordenadas.length; i++) {
                    const coord = coordenadas[i];
                    const nome = (coord.Nome || '').toLowerCase();
                    const tipoLocal = (coord['Tipo de Local'] || coord['tipo_local'] || coord['Tipo_de_Local'] || coord['tipo'] || coord['Tipo'] || '').toLowerCase();
                    
                    if (nome.includes(termoLower) || tipoLocal.includes(termoLower)) {
                        // Verificar se o √≠ndice j√° n√£o foi adicionado (evitar duplicatas)
                        if (!indicesEncontrados.includes(i)) {
                            indicesEncontrados.push(i);
                        }
                    }
                }
            });
            
            return indicesEncontrados.sort((a, b) => a - b);
        }

        // CORRE√á√ÉO: Obter contexto de pesquisa para m√∫ltiplos itens
        function obterContextoPesquisaMultipla(coordenadas, indicesItens) {
            if (indicesItens.length === 0) return coordenadas;
            
            // Encontrar o menor e maior √≠ndice para determinar o contexto
            const menorIndice = Math.min(...indicesItens);
            const maiorIndice = Math.max(...indicesItens);
            
            // Calcular o contexto (4 itens antes do primeiro e 4 itens depois do √∫ltimo)
            const inicio = Math.max(0, menorIndice - 4);
            const fim = Math.min(coordenadas.length, maiorIndice + 5); // +5 porque queremos 4 itens depois + o pr√≥prio item
            
            modoPesquisaContexto = true;
            
            // Mapear as posi√ß√µes dos itens pesquisados no contexto
            itemPesquisadoIndex = indicesItens.map(indice => indice - inicio);
            
            console.log(`üîç Contexto de pesquisa m√∫ltipla: ${indicesItens.length} itens de ${coordenadas.length} total`);
            console.log(`üîç Mostrando itens ${inicio} a ${fim-1} (${fim - inicio} itens)`);
            console.log(`üîç Itens pesquisados nas posi√ß√µes:`, itemPesquisadoIndex);
            
            return coordenadas.slice(inicio, fim);
        }

        function gerarTextoParaCopiar() {
            const checkboxesSelecionados = document.querySelectorAll('.item-checkbox:checked');
            let texto = '';
            
            checkboxesSelecionados.forEach(checkbox => {
                const nome = checkbox.getAttribute('data-nome');
                const latitude = checkbox.getAttribute('data-latitude');
                const longitude = checkbox.getAttribute('data-longitude');
                
                texto += `*Localiza√ß√£o aproximada da ${nome}:*\n`;
                texto += `https://www.google.com/maps/place/${latitude},${longitude}\n\n`;
            });
            
            return texto.trim();
        }

        function copiarParaAreaDeTransferencia(texto) {
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(texto);
            } else {
                return new Promise((resolve, reject) => {
                    const textArea = document.createElement('textarea');
                    textArea.value = texto;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        if (successful) {
                            resolve();
                        } else {
                            reject(new Error('Falha ao copiar texto'));
                        }
                    } catch (err) {
                        document.body.removeChild(textArea);
                        reject(err);
                    }
                });
            }
        }

        function mostrarToast(mensagem, tipo = 'sucesso') {
            const toast = document.getElementById('toast');
            toast.textContent = mensagem;
            toast.className = 'toast';
            
            if (tipo === 'erro') {
                toast.classList.add('error');
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // Fun√ß√µes de UI (User Interface)
        function atualizarBotoesAcao() {
            const btnExcluirCoordenadas = document.getElementById('btn-excluir-coordenadas');
            
            if (coordenadasSelecionadas.length > 0) {
                btnExcluirCoordenadas.classList.remove('hidden');
            } else {
                btnExcluirCoordenadas.classList.add('hidden');
            }
        }

        function alternarSelecaoCoordenada(coordId, coordElement) {
            const index = coordenadasSelecionadas.indexOf(coordId);
            
            if (index === -1) {
                coordenadasSelecionadas.push(coordId);
            } else {
                coordenadasSelecionadas.splice(index, 1);
            }
            
            atualizarBotoesAcao();
        }

        function copiarItensSelecionados() {
            const checkboxesSelecionados = document.querySelectorAll('.item-checkbox:checked');
            
            if (checkboxesSelecionados.length === 0) {
                mostrarToast('Por favor, selecione pelo menos um item para copiar.', 'erro');
                return;
            }
            
            const texto = gerarTextoParaCopiar();
            
            copiarParaAreaDeTransferencia(texto).then(() => {
                // REGISTRAR LOG DE C√ìPIA DE COORDENADAS
                registrarLog(usuarioLogado.nome, 'info', 'Coordenadas copiadas para √°rea de transfer√™ncia', 'Coordenadas', `${checkboxesSelecionados.length} coordenada(s) copiada(s)`);
                
                mostrarToast('Texto copiado para a √°rea de transfer√™ncia!');
            }).catch(err => {
                console.error('Erro ao copiar texto: ', err);
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = texto;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    // REGISTRAR LOG DE C√ìPIA DE COORDENADAS
                    registrarLog(usuarioLogado.nome, 'info', 'Coordenadas copiadas para √°rea de transfer√™ncia', 'Coordenadas', `${checkboxesSelecionados.length} coordenada(s) copiada(s)`);
                    
                    mostrarToast('Texto copiado para a √°rea de transfer√™ncia!');
                } catch (err2) {
                    console.error('Erro ao copiar texto (m√©todo alternativo): ', err2);
                    mostrarToast('Erro ao copiar texto. Tente novamente.', 'erro');
                }
            });
        }

        // CORRE√á√ÉO: Fun√ß√£o atualizarTabela para suportar pesquisa m√∫ltipla
        async function atualizarTabela(termoPesquisa = '') {
            const coordenadas = await obterCoordenadas();
            const tipoLocalSelecionado = document.getElementById('tipo-local-select').value;
            
            coordenadasFiltradas = coordenadas;
            if (termoPesquisa || tipoLocalSelecionado) {
                const termos = processarTermosPesquisa(termoPesquisa);
                const termo = termoPesquisa.toLowerCase();
                
                coordenadasFiltradas = coordenadas.filter(coord => {
                    const nome = coord.Nome || '';
                    const tipoLocal = coord['Tipo de Local'] || coord['tipo_local'] || coord['Tipo_de_Local'] || coord['tipo'] || coord['Tipo'] || '';
                    
                    // CORRE√á√ÉO: Pesquisa m√∫ltipla: verificar se corresponde a qualquer um dos termos
                    let correspondePesquisa = !termoPesquisa;
                    if (termos.length > 0) {
                        correspondePesquisa = termos.some(termo => 
                            nome.toLowerCase().includes(termo.toLowerCase()) ||
                            tipoLocal.toLowerCase().includes(termo.toLowerCase())
                        );
                    } else if (termoPesquisa) {
                        // Pesquisa √∫nica (compatibilidade)
                        correspondePesquisa = 
                            nome.toLowerCase().includes(termo) ||
                            tipoLocal.toLowerCase().includes(termo);
                    }
                    
                    const correspondeTipoLocal = !tipoLocalSelecionado || 
                        tipoLocal === tipoLocalSelecionado;
                    
                    return correspondePesquisa && correspondeTipoLocal;
                });
            }
            
            // CORRE√á√ÉO: Aplicar o contexto de pesquisa para m√∫ltiplos itens
            if (termoPesquisa && coordenadasFiltradas.length > 0) {
                const termos = processarTermosPesquisa(termoPesquisa);
                
                if (termos.length > 0) {
                    const indicesItens = encontrarItensPesquisados(coordenadasFiltradas, termos);
                    if (indicesItens.length > 0) {
                        coordenadasFiltradas = obterContextoPesquisaMultipla(coordenadasFiltradas, indicesItens);
                    } else {
                        modoPesquisaContexto = false;
                        itemPesquisadoIndex = -1;
                    }
                } else {
                    modoPesquisaContexto = false;
                    itemPesquisadoIndex = -1;
                }
            } else {
                modoPesquisaContexto = false;
                itemPesquisadoIndex = -1;
            }
            
            coordenadasSelecionadas = [];
            atualizarBotoesAcao();
            
            if (!modoPesquisaContexto) {
                paginaAtual = 1;
            }
            
            renderizarPagina();
            
            document.getElementById('total-coordenadas').textContent = coordenadas.length;
        }

        // Carregar coordenadas (fun√ß√£o principal)
        async function carregarCoordenadas() {
            console.log('üìç Carregando coordenadas...');
            await atualizarTabela();
        }

        // =============================================
        // SISTEMA DE CAIXAS - FUN√á√ïES PRODU√á√ÉO
        // =============================================

        // Configurar sistema de caixas
        function configurarSistemaCaixas() {
            const formCaixas = document.getElementById('form-caixas');
            const btnLimparCaixas = document.getElementById('btn-limpar-caixas');
            const btnUtilizarCaixas = document.getElementById('btn-utilizar-caixas');
            const btnEditarCaixas = document.getElementById('btn-editar-caixas');
            const btnExcluirCaixas = document.getElementById('btn-excluir-caixas');

            // Event listeners para fechar modais
            document.querySelectorAll('.close-modal').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });

            // CORRE√á√ÉO: Preencher automaticamente o campo de usu√°rio ao carregar a p√°gina
            document.addEventListener('DOMContentLoaded', function() {
                if (usuarioLogado) {
                    const usuarioCadastroInput = document.getElementById('usuario-cadastro');
                    if (usuarioCadastroInput) {
                        usuarioCadastroInput.value = usuarioLogado.nome;
                    }
                }
            });

            if (formCaixas) {
                formCaixas.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const caixasTexto = document.getElementById('caixas-texto').value;
                    const usuarioCadastro = document.getElementById('usuario-cadastro').value;
                    
                    if (!caixasTexto.trim() || !usuarioCadastro.trim()) {
                        mostrarToast('Por favor, preencha todos os campos obrigat√≥rios.', 'erro');
                        return;
                    }
                    
                    // CORRE√á√ÉO: Converter texto para mai√∫sculas
                    const nomesCaixas = caixasTexto.split(';').map(nome => nome.trim().toUpperCase()).filter(nome => nome !== '');
                    
                    if (nomesCaixas.length === 0) {
                        mostrarToast('Por favor, insira pelo menos um nome de caixa v√°lido.', 'erro');
                        return;
                    }
                    
                    // Cadastrar as caixas no banco de dados
                    const sucesso = await cadastrarCaixas(nomesCaixas, usuarioCadastro);
                    
                    if (sucesso) {
                        mostrarToast(`‚úÖ ${nomesCaixas.length} caixa(s) cadastrada(s) com sucesso!`);
                        formCaixas.reset();
                        
                        // CORRE√á√ÉO: Manter o campo de usu√°rio preenchido ap√≥s limpar o formul√°rio
                        const usuarioCadastroInput = document.getElementById('usuario-cadastro');
                        if (usuarioCadastroInput && usuarioLogado) {
                            usuarioCadastroInput.value = usuarioLogado.nome;
                        }
                        
                        atualizarListaCaixas();
                    }
                });
            }

            // CORRE√á√ÉO: Event listener para converter texto para mai√∫sculas automaticamente
            const caixasTextoInput = document.getElementById('caixas-texto');
            if (caixasTextoInput) {
                caixasTextoInput.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            }

            if (btnLimparCaixas) {
                btnLimparCaixas.addEventListener('click', function() {
                    document.getElementById('form-caixas').reset();
                    
                    // CORRE√á√ÉO: Manter o campo de usu√°rio preenchido ap√≥s limpar o formul√°rio
                    const usuarioCadastroInput = document.getElementById('usuario-cadastro');
                    if (usuarioCadastroInput && usuarioLogado) {
                        usuarioCadastroInput.value = usuarioLogado.nome;
                    }
                });
            }

            if (btnUtilizarCaixas) {
                btnUtilizarCaixas.addEventListener('click', function() {
                    if (caixasSelecionadas.length === 0) {
                        mostrarToast('Por favor, selecione pelo menos uma caixa para utilizar.', 'erro');
                        return;
                    }
                    
                    const caixasSelecionadasNomes = [];
                    caixasSelecionadas.forEach(id => {
                        const checkbox = document.querySelector(`#caixa-${id}`);
                        if (checkbox) {
                            const nome = checkbox.closest('.caixa-item').querySelector('.caixa-nome').textContent;
                            caixasSelecionadasNomes.push(nome);
                        }
                    });
                    
                    document.getElementById('caixas-selecionadas-nomes').textContent = caixasSelecionadasNomes.join(', ');
                    
                    // CORRE√á√ÉO: Preencher automaticamente o campo "Usu√°rio que est√° utilizando" com o nome do usu√°rio logado
                    document.getElementById('usuario-utilizacao').value = usuarioLogado ? usuarioLogado.nome : '';
                    
                    document.getElementById('evento-utilizacao').value = '';
                    document.getElementById('modal-utilizar-caixas').style.display = 'flex';
                });
            }

            if (btnEditarCaixas) {
                btnEditarCaixas.addEventListener('click', function() {
                    if (caixasSelecionadas.length === 0) {
                        mostrarToast('Por favor, selecione pelo menos uma caixa para editar.', 'erro');
                        return;
                    }
                    
                    const caixasSelecionadasNomes = [];
                    caixasSelecionadas.forEach(id => {
                        const checkbox = document.querySelector(`#caixa-${id}`);
                        if (checkbox) {
                            const nome = checkbox.closest('.caixa-item').querySelector('.caixa-nome').textContent;
                            caixasSelecionadasNomes.push(nome);
                        }
                    });
                    
                    document.getElementById('caixas-selecionadas-nomes-editar').textContent = caixasSelecionadasNomes.join(', ');
                    document.getElementById('novo-nome-caixa').value = '';
                    document.getElementById('novo-usuario-caixa').value = '';
                    document.getElementById('modal-editar-caixas').style.display = 'flex';
                });
            }

            if (btnExcluirCaixas) {
                btnExcluirCaixas.addEventListener('click', function() {
                    if (caixasSelecionadas.length === 0) {
                        mostrarToast('Por favor, selecione pelo menos uma caixa para excluir.', 'erro');
                        return;
                    }
                    
                    const caixasSelecionadasNomes = [];
                    caixasSelecionadas.forEach(id => {
                        const checkbox = document.querySelector(`#caixa-${id}`);
                        if (checkbox) {
                            const nome = checkbox.closest('.caixa-item').querySelector('.caixa-nome').textContent;
                            caixasSelecionadasNomes.push(nome);
                        }
                    });
                    
                    document.getElementById('itens-selecionados-exclusao').textContent = caixasSelecionadasNomes.join(', ');
                    document.getElementById('itens-selecionados-exclusao').setAttribute('data-tipo', 'caixas');
                    document.getElementById('modal-confirmar-exclusao').style.display = 'flex';
                });
            }

            // Event listeners para bot√µes de cancelar nos modais
            document.getElementById('btn-cancelar-retorno').addEventListener('click', function() {
                document.getElementById('modal-retornar-caixa').style.display = 'none';
            });
            
            document.getElementById('btn-cancelar-mover').addEventListener('click', function() {
                document.getElementById('modal-mover-coordenadas').style.display = 'none';
            });
            
            document.getElementById('btn-cancelar-utilizacao').addEventListener('click', function() {
                document.getElementById('modal-utilizar-caixas').style.display = 'none';
            });
            
            document.getElementById('btn-cancelar-editar').addEventListener('click', function() {
                document.getElementById('modal-editar-caixas').style.display = 'none';
            });
            
            document.getElementById('btn-cancelar-exclusao').addEventListener('click', function() {
                document.getElementById('modal-confirmar-exclusao').style.display = 'none';
            });

            // Event listeners para formul√°rios dos modais
            document.getElementById('form-retornar-caixa').addEventListener('submit', async function(e) {
                e.preventDefault();
                const caixaId = document.getElementById('caixa-id-retornar').value;
                const sucesso = await retornarCaixaParaDisponivel(caixaId);
                if (sucesso) {
                    document.getElementById('modal-retornar-caixa').style.display = 'none';
                    atualizarListaCaixas();
                }
            });

            document.getElementById('form-mover-coordenadas').addEventListener('submit', async function(e) {
                e.preventDefault();
                const caixaId = document.getElementById('caixa-id-mover').value;
                const latitude = document.getElementById('latitude-mover').value;
                const longitude = document.getElementById('longitude-mover').value;
                
                if (!latitude || !longitude) {
                    mostrarToast('Por favor, preencha a latitude e longitude.', 'erro');
                    return;
                }

                const sucesso = await moverCaixaParaCoordenadas(caixaId, latitude, longitude);
                if (sucesso) {
                    document.getElementById('modal-mover-coordenadas').style.display = 'none';
                    atualizarListaCaixas();
                }
            });

            document.getElementById('form-utilizar-caixas').addEventListener('submit', async function(e) {
                e.preventDefault();
                const usuarioUtilizacao = document.getElementById('usuario-utilizacao').value;
                const eventoUtilizacao = document.getElementById('evento-utilizacao').value;
                
                if (!usuarioUtilizacao || !eventoUtilizacao) {
                    mostrarToast('Por favor, preencha todos os campos obrigat√≥rios.', 'erro');
                    return;
                }

                const sucesso = await utilizarCaixas(caixasSelecionadas, usuarioUtilizacao, eventoUtilizacao);
                if (sucesso) {
                    document.getElementById('modal-utilizar-caixas').style.display = 'none';
                    caixasSelecionadas = [];
                    atualizarListaCaixas();
                }
            });

            document.getElementById('form-confirmar-exclusao').addEventListener('submit', async function(e) {
                e.preventDefault();
                const tipo = document.getElementById('itens-selecionados-exclusao').getAttribute('data-tipo');
                
                if (tipo === 'caixas') {
                    const sucesso = await excluirCaixas(caixasSelecionadas);
                    if (sucesso) {
                        document.getElementById('modal-confirmar-exclusao').style.display = 'none';
                        caixasSelecionadas = [];
                        atualizarListaCaixas();
                    }
                }
            });
        }

        // FUN√á√ïES DO BANCO DE DADOS PARA CAIXAS - MODO PRODU√á√ÉO

        // Buscar todas as caixas do banco
        async function obterCaixas() {
            document.getElementById('loading-caixas-disponiveis').classList.remove('hidden');
            document.getElementById('loading-caixas-utilizadas').classList.remove('hidden');
            
            try {
                console.log('üì¶ Buscando caixas do banco de dados...');
                
                const { data, error } = await supabase
                    .from(TABELA_CAIXAS)
                    .select('*')
                    .order('data_cadastro', { ascending: false });

                if (error) {
                    console.error('‚ùå Erro ao buscar caixas:', error);
                    throw error;
                }

                console.log(`‚úÖ ${data ? data.length : 0} caixas encontradas`);
                return data || [];
            } catch (error) {
                console.error('‚ùå Erro ao buscar caixas:', error);
                mostrarToast('Erro ao carregar caixas: ' + error.message, 'erro');
                return [];
            } finally {
                document.getElementById('loading-caixas-disponiveis').classList.add('hidden');
                document.getElementById('loading-caixas-utilizadas').classList.add('hidden');
            }
        }

        // PRODU√á√ÉO: Cadastrar novas caixas - VERS√ÉO OTIMIZADA
        async function cadastrarCaixas(nomesCaixas, usuarioCadastro) {
            try {
                console.log('‚ûï Cadastrando caixas:', nomesCaixas);
                
                // Preparar dados para inser√ß√£o
                const caixasParaCadastrar = nomesCaixas.map(nome => ({
                    nome: nome,
                    usuario_cadastro: usuarioCadastro,
                    usuario_utilizou: null,
                    evento: null,
                    data_utilizacao: null,
                    categoria: 'Caixa CE',
                    data_cadastro: new Date().toISOString(),
                    status: 'disponivel'
                }));

                console.log('Dados para cadastrar:', caixasParaCadastrar);

                // Inserir no banco
                const { data, error } = await supabase
                    .from(TABELA_CAIXAS)
                    .insert(caixasParaCadastrar)
                    .select();

                if (error) {
                    console.error('‚ùå Erro ao cadastrar caixas:', error);
                    throw error;
                }

                console.log('‚úÖ Caixas cadastradas com sucesso:', data);
                
                // REGISTRAR LOG DE CADASTRO DE CAIXAS
                await registrarLog(usuarioLogado.nome, 'info', `${nomesCaixas.length} caixa(s) cadastrada(s)`, 'Caixas', `Caixas: ${nomesCaixas.join(', ')}, Cadastrado por: ${usuarioCadastro}`);
                
                mostrarToast(`‚úÖ ${nomesCaixas.length} caixa(s) cadastrada(s) com sucesso!`);
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao cadastrar caixas:', error);
                mostrarToast('Erro ao cadastrar caixas: ' + error.message, 'erro');
                
                // REGISTRAR LOG DE ERRO
                await registrarLog(usuarioLogado.nome, 'error', 'Erro ao cadastrar caixas', 'Caixas', error.message);
                return false;
            }
        }

        // PRODU√á√ÉO: Utilizar caixas (marcar como utilizadas)
        async function utilizarCaixas(idsCaixas, usuarioUtilizou, evento) {
            try {
                console.log('üîß Utilizando caixas:', idsCaixas);
                
                // Buscar informa√ß√µes das caixas antes de atualizar para registrar no log
                const { data: caixasInfo, error: erroBusca } = await supabase
                    .from(TABELA_CAIXAS)
                    .select('*')
                    .in('id', idsCaixas);

                const { data, error } = await supabase
                    .from(TABELA_CAIXAS)
                    .update({
                        status: 'utilizada',
                        usuario_utilizou: usuarioUtilizou,
                        evento: evento,
                        data_utilizacao: new Date().toISOString()
                    })
                    .in('id', idsCaixas)
                    .select();

                if (error) {
                    console.error('‚ùå Erro ao utilizar caixas:', error);
                    throw error;
                }

                console.log('‚úÖ Caixas utilizadas com sucesso:', data);
                
                // REGISTRAR LOG DE UTILIZA√á√ÉO DE CAIXAS
                if (caixasInfo && caixasInfo.length > 0) {
                    const nomesCaixas = caixasInfo.map(caixa => caixa.nome).join(', ');
                    await registrarLog(usuarioLogado.nome, 'info', `${idsCaixas.length} caixa(s) utilizada(s)`, 'Caixas', `Caixas: ${nomesCaixas}, Utilizado por: ${usuarioUtilizou}, Evento: ${evento}`);
                }
                
                mostrarToast(`‚úÖ ${idsCaixas.length} caixa(s) marcada(s) como utilizada(s)!`);
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao utilizar caixas:', error);
                mostrarToast('Erro ao utilizar caixas: ' + error.message, 'erro');
                
                // REGISTRAR LOG DE ERRO
                await registrarLog(usuarioLogado.nome, 'error', 'Erro ao utilizar caixas', 'Caixas', error.message);
                return false;
            }
        }

        // PRODU√á√ÉO: Retornar caixa para dispon√≠vel
        async function retornarCaixaParaDisponivel(caixaId) {
            try {
                console.log('üîÑ Retornando caixa para dispon√≠vel:', caixaId);
                
                // Buscar informa√ß√µes da caixa antes de atualizar para registrar no log
                const { data: caixaInfo, error: erroBusca } = await supabase
                    .from(TABELA_CAIXAS)
                    .select('*')
                    .eq('id', caixaId)
                    .single();

                const { data, error } = await supabase
                    .from(TABELA_CAIXAS)
                    .update({
                        status: 'disponivel',
                        usuario_utilizou: null,
                        evento: null,
                        data_utilizacao: null
                    })
                    .eq('id', caixaId)
                    .select();

                if (error) {
                    console.error('‚ùå Erro ao retornar caixa:', error);
                    throw error;
                }

                console.log('‚úÖ Caixa retornada para dispon√≠vel:', data);
                
                // REGISTRAR LOG DE RETORNO DE CAIXA
                if (caixaInfo) {
                    await registrarLog(usuarioLogado.nome, 'info', 'Caixa retornada para dispon√≠vel', 'Caixas', `Caixa: ${caixaInfo.nome}`);
                }
                
                mostrarToast('‚úÖ Caixa retornada para dispon√≠vel!');
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao retornar caixa:', error);
                mostrarToast('Erro ao retornar caixa: ' + error.message, 'erro');
                
                // REGISTRAR LOG DE ERRO
                await registrarLog(usuarioLogado.nome, 'error', 'Erro ao retornar caixa', 'Caixas', error.message);
                return false;
            }
        }

        // PRODU√á√ÉO: Excluir caixas
        async function excluirCaixas(idsCaixas) {
            try {
                console.log('üóëÔ∏è Excluindo caixas:', idsCaixas);
                
                // Buscar informa√ß√µes das caixas antes de excluir para registrar no log
                const { data: caixasInfo, error: erroBusca } = await supabase
                    .from(TABELA_CAIXAS)
                    .select('*')
                    .in('id', idsCaixas);

                const { data, error } = await supabase
                    .from(TABELA_CAIXAS)
                    .delete()
                    .in('id', idsCaixas)
                    .select();

                if (error) {
                    console.error('‚ùå Erro ao excluir caixas:', error);
                    throw error;
                }

                console.log('‚úÖ Caixas exclu√≠das com sucesso:', data);
                
                // REGISTRAR LOG DE EXCLUS√ÉO DE CAIXAS
                if (caixasInfo && caixasInfo.length > 0) {
                    const nomesCaixas = caixasInfo.map(caixa => caixa.nome).join(', ');
                    await registrarLog(usuarioLogado.nome, 'warning', `${idsCaixas.length} caixa(s) exclu√≠da(s)`, 'Caixas', `Caixas exclu√≠das: ${nomesCaixas}`);
                }
                
                mostrarToast(`‚úÖ ${idsCaixas.length} caixa(s) exclu√≠da(s) com sucesso!`);
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao excluir caixas:', error);
                mostrarToast('Erro ao excluir caixas: ' + error.message, 'erro');
                
                // REGISTRAR LOG DE ERRO
                await registrarLog(usuarioLogado.nome, 'error', 'Erro ao excluir caixas', 'Caixas', error.message);
                return false;
            }
        }

        // CORRE√á√ÉO: Mover caixa para coordenadas (Caixas Ativas) com valida√ß√£o de duplicata
        async function moverCaixaParaCoordenadas(caixaId, latitude, longitude) {
            try {
                console.log('üîÑ Movendo caixa para coordenadas:', caixaId);
                
                // Buscar dados da caixa
                const { data: caixa, error: erroBusca } = await supabase
                    .from(TABELA_CAIXAS)
                    .select('*')
                    .eq('id', caixaId)
                    .single();

                if (erroBusca) {
                    console.error('‚ùå Erro ao buscar caixa:', erroBusca);
                    throw erroBusca;
                }

                // CORRE√á√ÉO: Validar se j√° existe coordenada com mesmo nome ou localiza√ß√£o
                const existeDuplicata = await validarCoordenadaDuplicada(caixa.nome, latitude, longitude);
                if (existeDuplicata) {
                    return false;
                }

                // Inserir na tabela de coordenadas
                const { data: novaCoordenada, error: erroInsercao } = await supabase
                    .from(TABELA_COORDENADAS)
                    .insert([
                        {
                            Nome: caixa.nome,
                            'Tipo de Local': 'Caixa CE',
                            Y: normalizarCoordenada(latitude),
                            X: normalizarCoordenada(longitude)
                        }
                    ])
                    .select();

                if (erroInsercao) {
                    console.error('‚ùå Erro ao inserir na tabela de coordenadas:', erroInsercao);
                    throw erroInsercao;
                }

                // Excluir a caixa da tabela de caixas
                const { error: erroExclusao } = await supabase
                    .from(TABELA_CAIXAS)
                    .delete()
                    .eq('id', caixaId);

                if (erroExclusao) {
                    console.error('‚ùå Erro ao excluir caixa:', erroExclusao);
                    throw erroExclusao;
                }

                console.log('‚úÖ Caixa movida para coordenadas com sucesso:', novaCoordenada);
                
                // REGISTRAR LOG DE MOVIMENTA√á√ÉO DE CAIXA
                await registrarLog(usuarioLogado.nome, 'info', 'Caixa movida para Caixas Ativas', 'Caixas', `Caixa: ${caixa.nome}, Coordenadas: ${latitude}, ${longitude}`);
                
                mostrarToast('‚úÖ Caixa movida para Caixas Ativas com sucesso!');
                atualizarListaCaixas();
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao mover caixa para coordenadas:', error);
                mostrarToast('Erro ao mover caixa: ' + error.message, 'erro');
                
                // REGISTRAR LOG DE ERRO
                await registrarLog(usuarioLogado.nome, 'error', 'Erro ao mover caixa para coordenadas', 'Caixas', error.message);
                return false;
            }
        }

        // PRODU√á√ÉO: Atualizar lista de caixas na interface - VERS√ÉO CORRIGIDA
        async function atualizarListaCaixas() {
            try {
                const caixas = await obterCaixas();
                const listaDisponiveis = document.getElementById('lista-caixas-disponiveis');
                const listaUtilizadas = document.getElementById('lista-caixas-utilizadas');
                const emptyStateDisponiveis = document.getElementById('empty-state-caixas');
                const emptyStateUtilizadas = document.getElementById('empty-state-caixas-utilizadas');
                
                // CORRE√á√ÉO: Preencher automaticamente o campo de usu√°rio logado
                const usuarioCadastroInput = document.getElementById('usuario-cadastro');
                if (usuarioCadastroInput && usuarioLogado) {
                    usuarioCadastroInput.value = usuarioLogado.nome;
                }
                
                caixasSelecionadas = [];
                atualizarBotoesAcaoCaixas();
                
                const caixasDisponiveis = caixas.filter(caixa => caixa.status === 'disponivel');
                const caixasUtilizadas = caixas.filter(caixa => caixa.status === 'utilizada');
                
                // Atualizar lista de caixas dispon√≠veis
                listaDisponiveis.innerHTML = '';
                
                if (caixasDisponiveis.length === 0) {
                    emptyStateDisponiveis.classList.remove('hidden');
                } else {
                    emptyStateDisponiveis.classList.add('hidden');
                    
                    caixasDisponiveis.forEach(caixa => {
                        const div = document.createElement('div');
                        div.className = 'caixa-item';
                        div.innerHTML = `
                            <div class="caixa-item-content">
                                <div class="caixa-info">
                                    <div class="caixa-header">
                                        <span class="caixa-nome">${caixa.nome}</span>
                                        <span class="status-badge status-active">Caixa dispon√≠vel</span>
                                    </div>
                                    <div class="caixa-details">
                                        <div class="caixa-details-grid">
                                            <div class="caixa-checkbox-container">
                                                <input type="checkbox" class="caixa-checkbox" id="caixa-${caixa.id}" data-id="${caixa.id}">
                                            </div>
                                            <div class="cadastro-info">
                                                <strong>Cadastrado por:</strong> ${caixa.usuario_cadastro || 'N/A'}
                                            </div>
                                            <div class="data-info">
                                                <strong>Data de cadastro:</strong> ${caixa.data_cadastro ? new Date(caixa.data_cadastro).toLocaleString('pt-BR') : 'N/A'}
                                            </div>
                                            ${caixa.categoria ? `<div class="categoria-info"><strong>Categoria:</strong> ${caixa.categoria}</div>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        listaDisponiveis.appendChild(div);
                        
                        const checkbox = div.querySelector(`#caixa-${caixa.id}`);
                        checkbox.addEventListener('change', function() {
                            alternarSelecaoCaixa(caixa.id, div);
                        });
                    });
                }
                
                // Atualizar lista de caixas utilizadas - VERS√ÉO CORRIGIDA
                listaUtilizadas.innerHTML = '';
                
                if (caixasUtilizadas.length === 0) {
                    emptyStateUtilizadas.classList.remove('hidden');
                } else {
                    emptyStateUtilizadas.classList.add('hidden');
                    
                    caixasUtilizadas.forEach(caixa => {
                        const div = document.createElement('div');
                        div.className = 'caixa-item';
                        div.innerHTML = `
                            <div class="caixa-item-content">
                                <div class="caixa-info">
                                    <div class="caixa-header">
                                        <span class="caixa-nome">${caixa.nome}</span>
                                        <span class="status-badge status-inactive">Caixa reservada</span>
                                    </div>
                                    <div class="caixa-details">
                                        <p><strong>Cadastrado por:</strong> ${caixa.usuario_cadastro || 'N/A'}</p>
                                        <p><strong>Utilizado por:</strong> ${caixa.usuario_utilizou || 'N/A'}</p>
                                        <p><strong>Evento:</strong> ${caixa.evento || 'N/A'}</p>
                                        <p><strong>Data de utiliza√ß√£o:</strong> ${caixa.data_utilizacao ? new Date(caixa.data_utilizacao).toLocaleString('pt-BR') : 'N/A'}</p>
                                        ${caixa.categoria ? `<p><strong>Categoria:</strong> ${caixa.categoria}</p>` : ''}
                                    </div>
                                </div>
                                <div class="caixa-actions">
                                    <button class="action-btn btn-success btn-mover-coordenadas" data-id="${caixa.id}" data-nome="${caixa.nome}">Mover para Caixas Ativas</button>
                                    <button class="action-btn btn-warning btn-retornar-caixa" data-id="${caixa.id}" data-nome="${caixa.nome}">Retornar para Dispon√≠vel</button>
                                </div>
                            </div>
                        `;
                        listaUtilizadas.appendChild(div);
                    });
                    
                    // Adicionar event listeners para os bot√µes de a√ß√£o nas caixas reservadas
                    document.querySelectorAll('.btn-retornar-caixa').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            const nome = this.getAttribute('data-nome');
                            document.getElementById('caixa-id-retornar').value = id;
                            document.getElementById('caixa-nome-retornar').textContent = nome;
                            document.getElementById('modal-retornar-caixa').style.display = 'flex';
                        });
                    });
                    
                    // CORRE√á√ÉO: Adicionar event listeners para o bot√£o "Mover para Caixas Ativas"
                    document.querySelectorAll('.btn-mover-coordenadas').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            const nome = this.getAttribute('data-nome');
                            document.getElementById('caixa-id-mover').value = id;
                            document.getElementById('caixa-nome-mover').textContent = nome;
                            document.getElementById('latitude-mover').value = '';
                            document.getElementById('longitude-mover').value = '';
                            document.getElementById('modal-mover-coordenadas').style.display = 'flex';
                        });
                    });
                }
            } catch (error) {
                console.error('‚ùå Erro ao atualizar lista de caixas:', error);
                mostrarToast('Erro ao carregar lista de caixas: ' + error.message, 'erro');
            }
        }

        function alternarSelecaoCaixa(caixaId, caixaElement) {
            const index = caixasSelecionadas.indexOf(caixaId);
            
            if (index === -1) {
                caixasSelecionadas.push(caixaId);
                caixaElement.classList.add('caixa-selecionada');
            } else {
                caixasSelecionadas.splice(index, 1);
                caixaElement.classList.remove('caixa-selecionada');
            }
            
            atualizarBotoesAcaoCaixas();
        }

        function atualizarBotoesAcaoCaixas() {
            const utilizarCaixasContainer = document.getElementById('utilizar-caixas-container');
            
            if (caixasSelecionadas.length > 0) {
                utilizarCaixasContainer.classList.remove('hidden');
                document.getElementById('btn-utilizar-caixas').textContent = `Utilizar ${caixasSelecionadas.length} Caixa(s)`;
            } else {
                utilizarCaixasContainer.classList.add('hidden');
            }
        }

        // =============================================
        // SISTEMA DE MATERIAIS - FUN√á√ïES CORRIGIDAS
        // =============================================

        // Configurar sistema de materiais
        function configurarSistemaMateriais() {
            // Configurar tabs
            document.querySelectorAll('.tab-materiais').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    alternarTabMateriais(tabId);
                });
            });

            // Configurar bot√µes de pesquisa
            document.getElementById('searchButtonMateriais').addEventListener('click', function() {
                pesquisarMateriais();
            });

            // Configurar limpar pesquisa
            document.getElementById('clearSearchMateriais').addEventListener('click', function() {
                document.getElementById('searchInputMateriais').value = '';
                this.style.display = 'none';
                pesquisarMateriais();
            });

            // Configurar selecionar todos
            document.getElementById('selectAllMateriais').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('#resultsBodyMateriais input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    if (this.checked) {
                        selectedItemsMateriais.add(checkbox.value);
                    } else {
                        selectedItemsMateriais.delete(checkbox.value);
                    }
                });
                atualizarInfoSelecaoMateriais();
            });

            // Configurar copiar selecionados
            document.getElementById('copySelectedMateriais').addEventListener('click', function() {
                copiarMateriaisSelecionados();
            });

            // CORRE√á√ÉO: Configurar bot√£o solicitar materiais
            document.getElementById('btn-solicitar-materiais').addEventListener('click', function() {
                solicitarMateriaisSelecionados();
            });

            // Configurar formul√°rio de material
            document.getElementById('materialForm').addEventListener('submit', function(e) {
                e.preventDefault();
                salvarMaterial();
            });

            // Configurar bot√£o cancelar
            document.getElementById('cancelButtonMateriais').addEventListener('click', function() {
                resetarFormularioMaterial();
            });

            // Configurar adicionar categoria
            document.getElementById('addCategoria').addEventListener('click', function() {
                adicionarCategoria();
            });

            // Configurar t√©cnico para solicita√ß√£o
            document.getElementById('tecnico').addEventListener('change', function() {
                atualizarPreviewEmail();
            });

            // Configurar enviar para Outlook
            document.getElementById('enviarOutlook').addEventListener('click', function() {
                abrirOutlook();
            });

            // Configurar campo de busca com debounce
            document.getElementById('searchInputMateriais').addEventListener('input', function() {
                const clearBtn = document.getElementById('clearSearchMateriais');
                clearBtn.style.display = this.value ? 'block' : 'none';
                
                clearTimeout(searchTimeoutMateriais);
                searchTimeoutMateriais = setTimeout(() => {
                    pesquisarMateriais();
                }, 500);
            });
        }

        // Inicializar sistema de materiais
        async function inicializarSistemaMateriais() {
            console.log('üì¶ Inicializando sistema de materiais...');
            
            try {
                // Carregar categorias
                await carregarCategorias();
                
                // Carregar materiais
                await carregarMateriais();
                
                // Carregar t√©cnicos
                carregarTecnicos();
                
                console.log('‚úÖ Sistema de materiais inicializado com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar sistema de materiais:', error);
                mostrarStatusMateriais('Erro ao carregar sistema de materiais: ' + error.message, 'error');
            }
        }

        // CORRE√á√ÉO: Carregar materiais do banco de dados usando as colunas espec√≠ficas
        async function carregarMateriais() {
            try {
                console.log('üì¶ Carregando materiais do banco...');
                
                // Buscar materiais usando as colunas espec√≠ficas
                const { data, error } = await supabase
                    .from(TABELA_MATERIAIS)
                    .select('*')
                    .order('C√≥digo', { ascending: true });

                if (error) {
                    console.error('‚ùå Erro ao carregar materiais:', error);
                    throw error;
                }

                materiais = data || [];
                console.log(`‚úÖ ${materiais.length} materiais carregados`);
                
                // Atualizar estat√≠sticas
                document.getElementById('total-materiais').textContent = materiais.length;
                
                // Atualizar interface
                exibirMateriais(materiais);
                
                return materiais;
            } catch (error) {
                console.error('‚ùå Erro ao carregar materiais:', error);
                mostrarStatusMateriais('Erro ao carregar materiais: ' + error.message, 'error');
                return [];
            }
        }

        // CORRE√á√ÉO: Exibir materiais na tabela usando as colunas espec√≠ficas
        function exibirMateriais(listaMateriais) {
            const tbody = document.getElementById('resultsBodyMateriais');
            
            if (!listaMateriais || listaMateriais.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-results-materiais">
                            <i class="fas fa-box-open"></i> Nenhum material encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = listaMateriais.map(material => `
                <tr>
                    <td>
                        <input type="checkbox" value="${material.C√≥digo}" 
                               onchange="alternarSelecaoMaterial('${material.C√≥digo}', this)">
                    </td>
                    <td>${material.C√≥digo}</td>
                    <td>${material.Descri√ß√£o || ''}</td>
                    <td>${material.Observa√ß√µes || ''}</td>
                    <td>${material.Categoria || ''}</td>
                    <td class="categoria-actions-materiais">
                        <button class="btn-edit-materiais" onclick="editarMaterial('${material.C√≥digo}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn-delete-materiais" onclick="excluirMaterial('${material.C√≥digo}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // CORRE√á√ÉO COMPLETA: Fun√ß√£o para editar material com modal - VERS√ÉO CORRIGIDA
        function editarMaterial(codigo) {
            console.log(`üîß Editando material: ${codigo}`);
            
            // Buscar o material na lista de materiais
            const material = materiais.find(m => m.C√≥digo === codigo);
            
            if (material) {
                console.log('üìù Material encontrado para edi√ß√£o:', material);
                
                // Criar ou mostrar modal de edi√ß√£o
                let modal = document.getElementById('modal-editar-material');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'modal-editar-material';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Editar Material</h3>
                                <button class="close-modal">&times;</button>
                            </div>
                            <form id="form-editar-material">
                                <input type="hidden" id="material-codigo-original" name="material-codigo-original">
                                
                                <div class="form-group">
                                    <label for="material-codigo-editar" class="required">C√≥digo *</label>
                                    <input type="text" id="material-codigo-editar" name="material-codigo-editar" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="material-descricao-editar" class="required">Descri√ß√£o do Produto *</label>
                                    <input type="text" id="material-descricao-editar" name="material-descricao-editar" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="material-categoria-editar" class="required">Categoria *</label>
                                    <select id="material-categoria-editar" name="material-categoria-editar" required>
                                        <option value="">Selecione uma categoria</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="material-observacoes-editar">Observa√ß√µes</label>
                                    <textarea id="material-observacoes-editar" name="material-observacoes-editar" rows="3"></textarea>
                                </div>
                                
                                <div class="modal-footer">
                                    <button type="button" class="btn-danger" id="btn-cancelar-editar-material">Cancelar</button>
                                    <button type="submit" class="btn-success" id="btn-salvar-editar-material">Salvar Altera√ß√µes</button>
                                </div>
                            </form>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Configurar event listeners do modal
                    configurarModalEditarMaterial();
                }
                
                // Preencher o formul√°rio com os dados do material
                document.getElementById('material-codigo-original').value = material.C√≥digo;
                document.getElementById('material-codigo-editar').value = material.C√≥digo || '';
                document.getElementById('material-descricao-editar').value = material.Descri√ß√£o || '';
                document.getElementById('material-observacoes-editar').value = material.Observa√ß√µes || '';
                
                // Preencher categorias no select
                const categoriaSelect = document.getElementById('material-categoria-editar');
                categoriaSelect.innerHTML = '<option value="">Selecione uma categoria</option>';
                categorias.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria.nome;
                    option.textContent = categoria.nome;
                    categoriaSelect.appendChild(option);
                });
                
                // Selecionar a categoria atual do material
                if (material.Categoria) {
                    categoriaSelect.value = material.Categoria;
                }
                
                // Mostrar modal
                modal.style.display = 'flex';
                
                console.log('‚úÖ Modal de edi√ß√£o aberto com dados preenchidos');
                
            } else {
                console.error('‚ùå Material n√£o encontrado para edi√ß√£o:', codigo);
                mostrarStatusMateriais(`Erro: Material ${codigo} n√£o encontrado`, 'error');
            }
        }

        // Configurar modal de edi√ß√£o de material
        function configurarModalEditarMaterial() {
            const modal = document.getElementById('modal-editar-material');
            const closeBtn = modal.querySelector('.close-modal');
            const cancelBtn = modal.querySelector('#btn-cancelar-editar-material');
            const form = modal.querySelector('#form-editar-material');
            
            // Fechar modal
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            cancelBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            // Fechar ao clicar fora do modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Submeter formul√°rio
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                await salvarEdicaoMaterial();
            });
        }

        // CORRE√á√ÉO: Salvar edi√ß√£o do material via modal
        async function salvarEdicaoMaterial() {
            const modal = document.getElementById('modal-editar-material');
            const codigoOriginal = document.getElementById('material-codigo-original').value;
            const codigo = document.getElementById('material-codigo-editar').value;
            const descricao = document.getElementById('material-descricao-editar').value;
            const categoria = document.getElementById('material-categoria-editar').value;
            const observacoes = document.getElementById('material-observacoes-editar').value;
            
            console.log('üíæ Salvando edi√ß√£o do material:', { 
                codigoOriginal, codigo, descricao, categoria, observacoes 
            });
            
            if (!codigo || !descricao || !categoria) {
                mostrarStatusMateriais('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }
            
            try {
                // Se o c√≥digo foi alterado, verificar se o novo c√≥digo j√° existe
                if (codigo !== codigoOriginal) {
                    const materialExistente = materiais.find(m => m.C√≥digo === codigo);
                    if (materialExistente) {
                        mostrarStatusMateriais('J√° existe um material com este c√≥digo', 'error');
                        return;
                    }
                }
                
                // Atualizar material
                const { data, error } = await supabase
                    .from(TABELA_MATERIAIS)
                    .update({
                        C√≥digo: codigo,
                        Descri√ß√£o: descricao,
                        Observa√ß√µes: observacoes,
                        Categoria: categoria
                    })
                    .eq('C√≥digo', codigoOriginal)
                    .select();

                if (error) {
                    console.error('‚ùå Erro ao atualizar material:', error);
                    throw error;
                }
                
                console.log('‚úÖ Material atualizado com sucesso:', data);
                
                // REGISTRAR LOG DE EDI√á√ÉO DE MATERIAL
                await registrarLog(usuarioLogado.nome, 'info', 'Material atualizado', 'Materiais', `C√≥digo: ${codigoOriginal} -> ${codigo}, Descri√ß√£o: ${descricao}, Categoria: ${categoria}`);
                
                // Fechar modal e recarregar dados
                modal.style.display = 'none';
                await carregarMateriais();
                mostrarStatusMateriais(`Material ${codigo} atualizado com sucesso!`, 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar edi√ß√£o do material:', error);
                mostrarStatusMateriais('Erro ao salvar edi√ß√£o: ' + error.message, 'error');
                
                // REGISTRAR LOG DE ERRO
                await registrarLog(usuarioLogado.nome, 'error', 'Erro ao editar material', 'Materiais', error.message);
            }
        }

        // CORRE√á√ÉO: Fun√ß√£o para salvar material (criar ou atualizar) - VERS√ÉO MELHORADA
        async function salvarMaterial() {
            const codigo = document.getElementById('codigo').value;
            const descricao = document.getElementById('descricao').value;
            const observacoes = document.getElementById('observacoes').value;
            const categoria = document.getElementById('categoria').value;
            
            console.log('üíæ Salvando material:', { codigo, descricao, observacoes, categoria });
            
            if (!codigo || !descricao || !categoria) {
                mostrarStatusMateriais('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }
            
            try {
                let resultado;
                
                // Criar novo material
                console.log(`‚ûï Criando novo material: ${codigo}`);
                
                // Verificar se o c√≥digo j√° existe
                const materialExistente = materiais.find(m => m.C√≥digo === codigo);
                if (materialExistente) {
                    mostrarStatusMateriais('J√° existe um material com este c√≥digo', 'error');
                    return;
                }
                
                // Criar novo material
                const { data, error } = await supabase
                    .from(TABELA_MATERIAIS)
                    .insert([
                        {
                            C√≥digo: codigo,
                            Descri√ß√£o: descricao,
                            Observa√ß√µes: observacoes,
                            Categoria: categoria
                        }
                    ])
                    .select();

                if (error) {
                    console.error('‚ùå Erro ao criar material:', error);
                    throw error;
                }
                
                resultado = data;
                console.log('‚úÖ Material criado com sucesso:', data);
                
                // REGISTRAR LOG DE CRIA√á√ÉO DE MATERIAL
                await registrarLog(usuarioLogado.nome, 'info', 'Novo material cadastrado', 'Materiais', `C√≥digo: ${codigo}, Descri√ß√£o: ${descricao}, Categoria: ${categoria}`);
                
                mostrarStatusMateriais(`Material ${codigo} cadastrado com sucesso!`, 'success');
                
                // Recarregar materiais e atualizar interface
                await carregarMateriais();
                resetarFormularioMaterial();
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar material:', error);
                mostrarStatusMateriais('Erro ao salvar material: ' + error.message, 'error');
                
                // REGISTRAR LOG DE ERRO
                await registrarLog(usuarioLogado.nome, 'error', 'Erro ao cadastrar material', 'Materiais', error.message);
            }
        }

        // CORRE√á√ÉO: Fun√ß√£o para excluir material
        async function excluirMaterial(codigo) {
            if (confirm(`Tem certeza que deseja excluir o material ${codigo}?`)) {
                try {
                    const { error } = await supabase
                        .from(TABELA_MATERIAIS)
                        .delete()
                        .eq('C√≥digo', codigo);

                    if (error) throw error;
                    
                    // REGISTRAR LOG DE EXCLUS√ÉO DE MATERIAL
                    await registrarLog(usuarioLogado.nome, 'warning', 'Material exclu√≠do', 'Materiais', `C√≥digo: ${codigo}`);
                    
                    mostrarStatusMateriais(`Material ${codigo} exclu√≠do com sucesso!`, 'success');
                    
                    // Recarregar materiais
                    await carregarMateriais();
                    
                } catch (error) {
                    console.error('Erro ao excluir material:', error);
                    mostrarStatusMateriais('Erro ao excluir material: ' + error.message, 'error');
                    
                    // REGISTRAR LOG DE ERRO
                    await registrarLog(usuarioLogado.nome, 'error', 'Erro ao excluir material', 'Materiais', error.message);
                }
            }
        }

        // Alternar sele√ß√£o de material
        function alternarSelecaoMaterial(codigo, checkbox) {
            if (checkbox.checked) {
                selectedItemsMateriais.add(codigo);
            } else {
                selectedItemsMateriais.delete(codigo);
            }
            atualizarInfoSelecaoMateriais();
        }

        // Atualizar informa√ß√µes de sele√ß√£o
        function atualizarInfoSelecaoMateriais() {
            const selectionInfo = document.getElementById('selectionInfoMateriais');
            const copyButton = document.getElementById('copySelectedMateriais');
            const solicitacaoButton = document.getElementById('btn-solicitar-materiais');
            const selectAll = document.getElementById('selectAllMateriais');
            
            if (selectedItemsMateriais.size > 0) {
                selectionInfo.textContent = `${selectedItemsMateriais.size} item(s) selecionado(s)`;
                copyButton.disabled = false;
                solicitacaoButton.disabled = false;
            } else {
                selectionInfo.textContent = 'Nenhum item selecionado';
                copyButton.disabled = true;
                solicitacaoButton.disabled = true;
            }
            
            // Atualizar checkbox "Selecionar todos"
            const totalCheckboxes = document.querySelectorAll('#resultsBodyMateriais input[type="checkbox"]').length;
            selectAll.checked = selectedItemsMateriais.size === totalCheckboxes && totalCheckboxes > 0;
            selectAll.indeterminate = selectedItemsMateriais.size > 0 && selectedItemsMateriais.size < totalCheckboxes;
        }

        // CORRE√á√ÉO: Copiar materiais selecionados usando as colunas espec√≠ficas
        function copiarMateriaisSelecionados() {
            if (selectedItemsMateriais.size === 0) {
                mostrarStatusMateriais('Nenhum material selecionado para copiar', 'warning');
                return;
            }
            
            const materiaisSelecionados = materiais.filter(m => selectedItemsMateriais.has(m.C√≥digo));
            const texto = materiaisSelecionados.map(m => 
                `${m.C√≥digo} - ${m.Descri√ß√£o || ''}${m.Observa√ß√µes ? ` (${m.Observa√ß√µes})` : ''}`
            ).join('\n');
            
            copiarParaAreaDeTransferencia(texto).then(() => {
                // REGISTRAR LOG DE C√ìPIA DE MATERIAIS
                registrarLog(usuarioLogado.nome, 'info', 'Materiais copiados para √°rea de transfer√™ncia', 'Materiais', `${selectedItemsMateriais.size} material(is) copiado(s)`);
                
                mostrarStatusMateriais(`${selectedItemsMateriais.size} material(is) copiado(s) para a √°rea de transfer√™ncia`, 'success');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                mostrarStatusMateriais('Erro ao copiar materiais', 'error');
            });
        }

        // CORRE√á√ÉO: Solicitar materiais selecionados
        function solicitarMateriaisSelecionados() {
            if (selectedItemsMateriais.size === 0) {
                mostrarStatusMateriais('Nenhum material selecionado para solicitar', 'warning');
                return;
            }
            
            // Adicionar materiais selecionados √† solicita√ß√£o
            selectedItemsMateriais.forEach(codigo => {
                const material = materiais.find(m => m.C√≥digo === codigo);
                if (material && !solicitacaoItemsMateriais.has(codigo)) {
                    solicitacaoItemsMateriais.set(codigo, {
                        ...material,
                        quantidade: 1
                    });
                }
            });
            
            // Navegar para a aba de solicita√ß√£o
            alternarTabMateriais('solicitacao-materiais');
            
            // Atualizar a lista de solicita√ß√£o
            atualizarSolicitacaoMateriais();
            
            // REGISTRAR LOG DE SOLICITA√á√ÉO DE MATERIAIS
            registrarLog(usuarioLogado.nome, 'info', 'Materiais adicionados √† solicita√ß√£o', 'Solicita√ß√£o de Materiais', `${selectedItemsMateriais.size} material(is) adicionado(s) √† solicita√ß√£o`);
            
            mostrarStatusMateriais(`${selectedItemsMateriais.size} material(is) adicionado(s) √† solicita√ß√£o`, 'success');
        }

        // CORRE√á√ÉO: Pesquisar materiais usando as colunas espec√≠ficas
        function pesquisarMateriais() {
            const termo = document.getElementById('searchInputMateriais').value.toLowerCase();
            const categoria = document.getElementById('categoryFilterMateriais').value;
            
            let resultados = materiais;
            
            // Aplicar filtros
            if (termo) {
                resultados = resultados.filter(m => {
                    const codigo = (m.C√≥digo || '').toString().toLowerCase();
                    const descricao = (m.Descri√ß√£o || '').toLowerCase();
                    const observacoes = (m.Observa√ß√µes || '').toLowerCase();
                    
                    return codigo.includes(termo) ||
                           descricao.includes(termo) ||
                           observacoes.includes(termo);
                });
            }
            
            if (categoria) {
                resultados = resultados.filter(m => (m.Categoria || '') === categoria);
            }
            
            // Exibir resultados
            exibirMateriais(resultados);
            
            // Atualizar informa√ß√µes de sele√ß√£o
            selectedItemsMateriais.clear();
            atualizarInfoSelecaoMateriais();
        }

        // CORRE√á√ÉO: Carregar categorias do banco de dados
        async function carregarCategorias() {
            try {
                console.log('üè∑Ô∏è Carregando categorias...');
                
                const { data, error } = await supabase
                    .from(TABELA_CATEGORIAS)
                    .select('*')
                    .order('nome', { ascending: true });

                if (error) {
                    console.error('‚ùå Erro ao carregar categorias:', error);
                    throw error;
                }

                categorias = data || [];
                console.log(`‚úÖ ${categorias.length} categorias carregadas`);
                
                // Atualizar selects de categoria
                atualizarSelectsCategoria();
                
                // Atualizar lista de categorias
                carregarListaCategorias();
                
                return categorias;
            } catch (error) {
                console.error('‚ùå Erro ao carregar categorias:', error);
                mostrarStatusMateriais('Erro ao carregar categorias: ' + error.message, 'error');
                return [];
            }
        }

        // Atualizar selects de categoria
        function atualizarSelectsCategoria() {
            const selectCadastro = document.getElementById('categoria');
            const selectFiltro = document.getElementById('categoryFilterMateriais');
            
            // Limpar selects
            selectCadastro.innerHTML = '<option value="">Selecione uma categoria</option>';
            selectFiltro.innerHTML = '<option value="">Todas as categorias</option>';
            
            // Adicionar categorias
            categorias.forEach(categoria => {
                const optionCadastro = document.createElement('option');
                optionCadastro.value = categoria.nome;
                optionCadastro.textContent = categoria.nome;
                selectCadastro.appendChild(optionCadastro);
                
                const optionFiltro = document.createElement('option');
                optionFiltro.value = categoria.nome;
                optionFiltro.textContent = categoria.nome;
                selectFiltro.appendChild(optionFiltro);
            });
        }

        // CORRE√á√ÉO: Carregar lista de categorias na interface
        function carregarListaCategorias() {
            const categoriasList = document.getElementById('categoriasList');
            
            if (categorias.length === 0) {
                categoriasList.innerHTML = '<p>Nenhuma categoria cadastrada.</p>';
                return;
            }
            
            categoriasList.innerHTML = categorias.map((categoria, index) => `
                <div class="categoria-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span>${categoria.nome}</span>
                        <div class="categoria-actions">
                            <!-- CORRE√á√ÉO: Bot√£o Editar adicionado -->
                            <button class="btn btn-edit-materiais" onclick="editarCategoria(${categoria.id}, '${categoria.nome}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-delete-materiais" onclick="excluirCategoria(${categoria.id}, '${categoria.nome}')">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // CORRE√á√ÉO: Adicionar nova categoria
        async function adicionarCategoria() {
            const novaCategoriaInput = document.getElementById('novaCategoria');
            const nomeCategoria = novaCategoriaInput.value.trim();
            
            if (!nomeCategoria) {
                mostrarStatusMateriais('Digite o nome da nova categoria', 'warning');
                return;
            }
            
            // Verificar se a categoria j√° existe
            const categoriaExistente = categorias.find(c => c.nome.toLowerCase() === nomeCategoria.toLowerCase());
            if (categoriaExistente) {
                mostrarStatusMateriais('J√° existe uma categoria com este nome', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from(TABELA_CATEGORIAS)
                    .insert([{ nome: nomeCategoria }])
                    .select();

                if (error) throw error;
                
                // REGISTRAR LOG DE CRIA√á√ÉO DE CATEGORIA
                await registrarLog(usuarioLogado.nome, 'info', 'Nova categoria criada', 'Categorias', `Categoria: ${nomeCategoria}`);
                
                mostrarStatusMateriais(`Categoria "${nomeCategoria}" adicionada com sucesso!`, 'success');
                
                // Limpar campo e recarregar categorias
                novaCategoriaInput.value = '';
                await carregarCategorias();
                
            } catch (error) {
                console.error('Erro ao adicionar categoria:', error);
                mostrarStatusMateriais('Erro ao adicionar categoria: ' + error.message, 'error');
                
                // REGISTRAR LOG DE ERRO
                await registrarLog(usuarioLogado.nome, 'error', 'Erro ao adicionar categoria', 'Categorias', error.message);
            }
        }

        // CORRE√á√ÉO: Fun√ß√£o para editar categoria
        async function editarCategoria(id, nomeAtual) {
            const novoNome = prompt('Digite o novo nome para a categoria:', nomeAtual);
            
            if (novoNome && novoNome.trim() !== '' && novoNome !== nomeAtual) {
                try {
                    // Verificar se j√° existe uma categoria com o novo nome
                    const categoriaExistente = categorias.find(c => c.nome.toLowerCase() === novoNome.toLowerCase() && c.id !== id);
                    if (categoriaExistente) {
                        mostrarStatusMateriais('J√° existe uma categoria com este nome', 'error');
                        return;
                    }
                    
                    // Atualizar a categoria
                    const { error } = await supabase
                        .from(TABELA_CATEGORIAS)
                        .update({ nome: novoNome })
                        .eq('id', id);

                    if (error) throw error;
                    
                    // Atualizar tamb√©m os materiais que usam esta categoria
                    const { error: erroMateriais } = await supabase
                        .from(TABELA_MATERIAIS)
                        .update({ Categoria: novoNome })
                        .eq('Categoria', nomeAtual);

                    if (erroMateriais) {
                        console.error('Erro ao atualizar materiais:', erroMateriais);
                    }
                    
                    // REGISTRAR LOG DE EDI√á√ÉO DE CATEGORIA
                    await registrarLog(usuarioLogado.nome, 'info', 'Categoria atualizada', 'Categorias', `Categoria: ${nomeAtual} -> ${novoNome}`);
                    
                    mostrarStatusMateriais(`Categoria "${nomeAtual}" atualizada para "${novoNome}" com sucesso!`, 'success');
                    
                    // Recarregar categorias e materiais
                    await carregarCategorias();
                    await carregarMateriais();
                    
                } catch (error) {
                    console.error('Erro ao editar categoria:', error);
                    mostrarStatusMateriais('Erro ao editar categoria: ' + error.message, 'error');
                    
                    // REGISTRAR LOG DE ERRO
                    await registrarLog(usuarioLogado.nome, 'error', 'Erro ao editar categoria', 'Categorias', error.message);
                }
            }
        }

        // CORRE√á√ÉO: Excluir categoria
        async function excluirCategoria(id, nome) {
            if (confirm(`Tem certeza que deseja excluir a categoria "${nome}"?`)) {
                try {
                    // Verificar se existem materiais usando esta categoria
                    const { data: materiaisNaCategoria, error: erroMateriais } = await supabase
                        .from(TABELA_MATERIAIS)
                        .select('C√≥digo')
                        .eq('Categoria', nome)
                        .limit(1);

                    if (erroMateriais) throw erroMateriais;
                    
                    if (materiaisNaCategoria && materiaisNaCategoria.length > 0) {
                        mostrarStatusMateriais(`N√£o √© poss√≠vel excluir a categoria "${nome}" porque existem materiais vinculados a ela`, 'error');
                        return;
                    }
                    
                    // Excluir a categoria
                    const { error } = await supabase
                        .from(TABELA_CATEGORIAS)
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    // REGISTRAR LOG DE EXCLUS√ÉO DE CATEGORIA
                    await registrarLog(usuarioLogado.nome, 'warning', 'Categoria exclu√≠da', 'Categorias', `Categoria: ${nome}`);
                    
                    mostrarStatusMateriais(`Categoria "${nome}" exclu√≠da com sucesso!`, 'success');
                    
                    // Recarregar categorias
                    await carregarCategorias();
                    
                } catch (error) {
                    console.error('Erro ao excluir categoria:', error);
                    mostrarStatusMateriais('Erro ao excluir categoria: ' + error.message, 'error');
                    
                    // REGISTRAR LOG DE ERRO
                    await registrarLog(usuarioLogado.nome, 'error', 'Erro ao excluir categoria', 'Categorias', error.message);
                }
            }
        }

        // Alternar tab de materiais
        function alternarTabMateriais(tabId) {
            // Atualizar tabs
            document.querySelectorAll('.tab-materiais').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content-materiais').forEach(content => {
                content.classList.remove('active');
            });
            
            // Ativar tab selecionada
            document.querySelector(`.tab-materiais[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // A√ß√µes espec√≠ficas por tab
            if (tabId === 'consultar-materiais') {
                pesquisarMateriais();
            } else if (tabId === 'cadastrar-materiais') {
                resetarFormularioMaterial();
            } else if (tabId === 'categorias-materiais') {
                carregarListaCategorias();
            } else if (tabId === 'solicitacao-materiais') {
                atualizarSolicitacaoMateriais();
            }
        }

        // Mostrar status no sistema de materiais
        function mostrarStatusMateriais(mensagem, tipo) {
            const statusElement = document.getElementById('statusMessageMateriais');
            statusElement.textContent = mensagem;
            statusElement.className = `status-message-materiais status-${tipo}-materiais`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Carregar t√©cnicos
        function carregarTecnicos() {
            const selectTecnico = document.getElementById('tecnico');
            selectTecnico.innerHTML = '<option value="">Selecione o t√©cnico</option>';
            
            tecnicos.forEach(tecnico => {
                const option = document.createElement('option');
                option.value = tecnico;
                option.textContent = tecnico;
                selectTecnico.appendChild(option);
            });
        }

        // CORRE√á√ÉO: Resetar formul√°rio de material - VERS√ÉO MELHORADA
        function resetarFormularioMaterial() {
            console.log('üîÑ Resetando formul√°rio de material');
            
            document.getElementById('materialForm').reset();
            document.getElementById('formTitleMateriais').innerHTML = '<i class="fas fa-plus-circle"></i> Cadastrar Novo Material';
            document.getElementById('submitButtonMateriais').innerHTML = '<i class="fas fa-save"></i> Cadastrar Material';
            
            // Reabilitar campo c√≥digo
            const codigoInput = document.getElementById('codigo');
            codigoInput.disabled = false;
            codigoInput.focus(); // Dar foco ao campo c√≥digo
            
            console.log('‚úÖ Formul√°rio resetado com sucesso');
        }

        // CORRE√á√ÉO: Atualizar solicita√ß√£o de materiais
        function atualizarSolicitacaoMateriais() {
            const tbody = document.getElementById('solicitacaoResultsBody');
            const selectionInfo = document.getElementById('solicitacaoSelectionInfo');
            
            if (solicitacaoItemsMateriais.size === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-results-materiais">
                            <i class="fas fa-box-open"></i> Nenhum material adicionado √† solicita√ß√£o
                        </td>
                    </tr>
                `;
                selectionInfo.textContent = 'Nenhum item selecionado';
                document.getElementById('enviarOutlook').disabled = true;
                return;
            }
            
            tbody.innerHTML = Array.from(solicitacaoItemsMateriais.values()).map(material => `
                <tr>
                    <td>
                        <button class="btn-delete-materiais" onclick="removerDaSolicitacao('${material.C√≥digo}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                    <td>
                        <input type="number" class="quantidade-input" value="${material.quantidade}" min="1" 
                               onchange="atualizarQuantidadeSolicitacao('${material.C√≥digo}', this.value)">
                    </td>
                    <td>${material.C√≥digo}</td>
                    <td>${material.Descri√ß√£o || ''}</td>
                    <td>${material.Categoria || ''}</td>
                </tr>
            `).join('');
            
            selectionInfo.textContent = `${solicitacaoItemsMateriais.size} item(s) na solicita√ß√£o`;
            document.getElementById('enviarOutlook').disabled = false;
            
            // Atualizar preview do email
            atualizarPreviewEmail();
        }

        // CORRE√á√ÉO: Remover item da solicita√ß√£o
        function removerDaSolicitacao(codigo) {
            solicitacaoItemsMateriais.delete(codigo);
            atualizarSolicitacaoMateriais();
            
            // REGISTRAR LOG DE REMO√á√ÉO DE SOLICITA√á√ÉO
            registrarLog(usuarioLogado.nome, 'info', 'Item removido da solicita√ß√£o', 'Solicita√ß√£o de Materiais', `C√≥digo: ${codigo}`);
            
            mostrarStatusMateriais('Item removido da solicita√ß√£o', 'info');
        }

        // CORRE√á√ÉO: Atualizar quantidade na solicita√ß√£o
        function atualizarQuantidadeSolicitacao(codigo, quantidade) {
            const material = solicitacaoItemsMateriais.get(codigo);
            if (material) {
                material.quantidade = parseInt(quantidade) || 1;
                solicitacaoItemsMateriais.set(codigo, material);
                atualizarPreviewEmail();
            }
        }

        // CORRE√á√ÉO: Atualizar preview do email - FORMATO SOLICITADO
        function atualizarPreviewEmail() {
            const tecnico = document.getElementById('tecnico').value;
            const emailPreview = document.getElementById('emailPreview');
            const emailAssunto = document.getElementById('emailAssunto');
            
            if (!tecnico) {
                emailPreview.textContent = 'Selecione um t√©cnico e itens para visualizar o email.';
                return;
            }
            
            if (solicitacaoItemsMateriais.size === 0) {
                emailPreview.textContent = 'Adicione itens √† solicita√ß√£o para visualizar o email.';
                return;
            }
            
            let emailContent = `Prezados,\n\n`;
            emailContent += `Solicito os seguintes materiais para ${tecnico}:\n\n`;
            
            Array.from(solicitacaoItemsMateriais.values()).forEach(material => {
                // CORRE√á√ÉO: Alterar formato de "‚Ä¢ 1x" para "1 -"
                emailContent += `${material.quantidade} - ${material.C√≥digo} - ${material.Descri√ß√£o || ''}`;
                if (material.Observa√ß√µes) {
                    emailContent += ` (${material.Observa√ß√µes})`;
                }
                emailContent += `\n`;
            });
            
            emailPreview.textContent = emailContent;
            emailAssunto.textContent = `Solicita√ß√£o de material - ${tecnico}`;
        }

        // CORRE√á√ÉO: Abrir Outlook com a solicita√ß√£o - FORMATO SOLICITADO
        function abrirOutlook() {
            const tecnico = document.getElementById('tecnico').value;
            
            if (!tecnico) {
                mostrarStatusMateriais('Selecione um t√©cnico para enviar a solicita√ß√£o', 'error');
                return;
            }
            
            if (solicitacaoItemsMateriais.size === 0) {
                mostrarStatusMateriais('Adicione itens √† solicita√ß√£o antes de enviar', 'error');
                return;
            }
            
            const assunto = `Solicita√ß√£o de material - ${tecnico}`;
            
            let corpoEmail = `Prezados,%0D%0A%0D%0A`;
            corpoEmail += `Solicito os seguintes materiais para ${tecnico}:%0D%0A%0D%0A`;
            
            Array.from(solicitacaoItemsMateriais.values()).forEach(material => {
                // CORRE√á√ÉO: Alterar formato de "‚Ä¢ 1x" para "1 -"
                corpoEmail += `${material.quantidade} - ${material.C√≥digo} - ${material.Descri√ß√£o || ''}`;
                if (material.Observa√ß√µes) {
                    corpoEmail += ` (${material.Observa√ß√µes})`;
                }
                corpoEmail += `%0D%0A`;
            });
            
            // CORRE√á√ÉO: Preencher automaticamente os emails
            const paraEmail = 'almoxarifado@sodobrasil.net.br';
            const ccEmail = 'construcao@sodobrasil.net.br';
            
            const outlookUrl = `mailto:${paraEmail}?cc=${ccEmail}&subject=${encodeURIComponent(assunto)}&body=${corpoEmail}`;
            
            // REGISTRAR LOG DE SOLICITA√á√ÉO VIA EMAIL
            registrarLog(usuarioLogado.nome, 'info', 'Solicita√ß√£o de materiais enviada por email', 'Solicita√ß√£o de Materiais', `T√©cnico: ${tecnico}, Itens: ${solicitacaoItemsMateriais.size}`);
            
            window.open(outlookUrl, '_blank');
            mostrarStatusMateriais('Email aberto no Outlook com os destinat√°rios pr√©-definidos.', 'info');
        }
    </script>
</body>
</html>